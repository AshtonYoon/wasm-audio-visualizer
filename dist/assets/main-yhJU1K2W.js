var Ht=Object.defineProperty;var Vt=(F,i,a)=>i in F?Ht(F,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):F[i]=a;var at=(F,i,a)=>Vt(F,typeof i!="symbol"?i+"":i,a);import{V as xt,P as Ot}from"./performance-monitor-lzUO1Pjl.js";async function Nt(F={}){var i,a=F,d=import.meta.url,f="";function u(t){return a.locateFile?a.locateFile(t,f):f+t}var y;{try{f=new URL(".",d).href}catch{}y=async t=>{var e=await fetch(t,{credentials:"same-origin"});if(e.ok)return e.arrayBuffer();throw new Error(e.status+" : "+e.url)}}var S=console.log.bind(console),m=console.error.bind(console),g,v=!1,P,h,p,B,z,k,A,q,U,$,L=!1;function H(){var t=E.buffer;a.HEAP8=p=new Int8Array(t),z=new Int16Array(t),a.HEAPU8=B=new Uint8Array(t),k=new Int32Array(t),A=new Uint32Array(t),a.HEAPF32=q=new Float32Array(t),U=new Float64Array(t),$=new BigInt64Array(t),new BigUint64Array(t)}function it(){if(a.preRun)for(typeof a.preRun=="function"&&(a.preRun=[a.preRun]);a.preRun.length;)yt(a.preRun.shift());V(O)}function st(){L=!0,b.g()}function rt(){if(a.postRun)for(typeof a.postRun=="function"&&(a.postRun=[a.postRun]);a.postRun.length;)mt(a.postRun.shift());V(x)}function T(t){var n;(n=a.onAbort)==null||n.call(a,t),t="Aborted("+t+")",m(t),v=!0,t+=". Build with -sASSERTIONS for more info.";var e=new WebAssembly.RuntimeError(t);throw h==null||h(e),e}var W;function ot(){return a.locateFile?u("audio-visualizer.wasm"):new URL("/audio-visualizer.wasm",import.meta.url).href}function ut(t){if(t==W&&g)return new Uint8Array(g);throw"both async and sync fetching of the wasm failed"}async function lt(t){if(!g)try{var e=await y(t);return new Uint8Array(e)}catch{}return ut(t)}async function ct(t,e){try{var n=await lt(t),s=await WebAssembly.instantiate(n,e);return s}catch(l){m(`failed to asynchronously prepare wasm: ${l}`),T(l)}}async function ht(t,e,n){if(!t)try{var s=fetch(e,{credentials:"same-origin"}),l=await WebAssembly.instantiateStreaming(s,n);return l}catch(o){m(`wasm streaming compile failed: ${o}`),m("falling back to ArrayBuffer instantiation")}return ct(e,n)}function ft(){var t={a:Wt};return t}async function dt(){function t(o,r){return b=o.exports,$t(b),H(),b}function e(o){return t(o.instance)}var n=ft();if(a.instantiateWasm)return new Promise((o,r)=>{a.instantiateWasm(n,(c,_)=>{o(t(c))})});W??(W=ot());var s=await ht(g,W,n),l=e(s);return l}var V=t=>{for(;t.length>0;)t.shift()(a)},x=[],mt=t=>x.push(t),O=[],yt=t=>O.push(t);function gt(t,e="i8"){switch(e.endsWith("*")&&(e="*"),e){case"i1":return p[t];case"i8":return p[t];case"i16":return z[t>>1];case"i32":return k[t>>2];case"i64":return $[t>>3];case"float":return q[t>>2];case"double":return U[t>>3];case"*":return A[t>>2];default:T(`invalid type for getValue: ${e}`)}}function pt(t,e,n="i8"){switch(n.endsWith("*")&&(n="*"),n){case"i1":p[t]=e;break;case"i8":p[t]=e;break;case"i16":z[t>>1]=e;break;case"i32":k[t>>2]=e;break;case"i64":$[t>>3]=BigInt(e);break;case"float":q[t>>2]=e;break;case"double":U[t>>3]=e;break;case"*":A[t>>2]=e;break;default:T(`invalid type for setValue: ${n}`)}}var vt=t=>Z(t),wt=()=>tt(),N=globalThis.TextDecoder&&new TextDecoder,Ft=(t,e,n,s)=>{for(var l=e+n;t[e]&&!(e>=l);)++e;return e},j=(t,e=0,n,s)=>{var l=Ft(t,e,n);if(l-e>16&&t.buffer&&N)return N.decode(t.subarray(e,l));for(var o="";e<l;){var r=t[e++];if(!(r&128)){o+=String.fromCharCode(r);continue}var c=t[e++]&63;if((r&224)==192){o+=String.fromCharCode((r&31)<<6|c);continue}var _=t[e++]&63;if((r&240)==224?r=(r&15)<<12|c<<6|_:r=(r&7)<<18|c<<12|_<<6|t[e++]&63,r<65536)o+=String.fromCharCode(r);else{var C=r-65536;o+=String.fromCharCode(55296|C>>10,56320|C&1023)}}return o},D=(t,e,n)=>t?j(B,t,e):"",At=(t,e,n,s)=>T(`Assertion failed: ${D(t)}, at: `+[e?D(e):"unknown filename",n,s?D(s):"unknown function"]);class _t{constructor(e){this.excPtr=e,this.ptr=e-24}set_type(e){A[this.ptr+4>>2]=e}get_type(){return A[this.ptr+4>>2]}set_destructor(e){A[this.ptr+8>>2]=e}get_destructor(){return A[this.ptr+8>>2]}set_caught(e){e=e?1:0,p[this.ptr+12]=e}get_caught(){return p[this.ptr+12]!=0}set_rethrown(e){e=e?1:0,p[this.ptr+13]=e}get_rethrown(){return p[this.ptr+13]!=0}init(e,n){this.set_adjusted_ptr(0),this.set_type(e),this.set_destructor(n)}set_adjusted_ptr(e){A[this.ptr+16>>2]=e}get_adjusted_ptr(){return A[this.ptr+16>>2]}}var J=0,St=(t,e,n)=>{var s=new _t(t);throw s.init(e,n),J=t,J},Pt=()=>T(""),Ct=()=>1073741824,Mt=(t,e)=>Math.ceil(t/e)*e,Bt=t=>{var e=E.buffer.byteLength,n=(t-e+65535)/65536|0;try{return E.grow(n),H(),1}catch{}},Tt=t=>{var e=B.length;t>>>=0;var n=Ct();if(t>n)return!1;for(var s=1;s<=4;s*=2){var l=e*(1+.2/s);l=Math.min(l,t+100663296);var o=Math.min(n,Mt(Math.max(t,l),65536)),r=Bt(o);if(r)return!0}return!1},bt=[null,[],[]],Rt=(t,e)=>{var n=bt[t];e===0||e===10?((t===1?S:m)(j(n)),n.length=0):n.push(e)},Dt=(t,e,n,s)=>{for(var l=0,o=0;o<n;o++){var r=A[e>>2],c=A[e+4>>2];e+=8;for(var _=0;_<c;_++)Rt(t,B[r+_]);l+=c}return A[s>>2]=l,0},K=t=>{var e=a["_"+t];return e},Q=(t,e)=>{p.set(t,e)},Et=t=>{for(var e=0,n=0;n<t.length;++n){var s=t.charCodeAt(n);s<=127?e++:s<=2047?e+=2:s>=55296&&s<=57343?(e+=4,++n):e+=3}return e},zt=(t,e,n,s)=>{if(!(s>0))return 0;for(var l=n,o=n+s-1,r=0;r<t.length;++r){var c=t.codePointAt(r);if(c<=127){if(n>=o)break;e[n++]=c}else if(c<=2047){if(n+1>=o)break;e[n++]=192|c>>6,e[n++]=128|c&63}else if(c<=65535){if(n+2>=o)break;e[n++]=224|c>>12,e[n++]=128|c>>6&63,e[n++]=128|c&63}else{if(n+3>=o)break;e[n++]=240|c>>18,e[n++]=128|c>>12&63,e[n++]=128|c>>6&63,e[n++]=128|c&63,r++}}return e[n]=0,n-l},kt=(t,e,n)=>zt(t,B,e,n),X=t=>G(t),qt=t=>{var e=Et(t)+1,n=X(e);return kt(t,n,e),n},Y=(t,e,n,s,l)=>{var o={string:w=>{var R=0;return w!=null&&w!==0&&(R=qt(w)),R},array:w=>{var R=X(w.length);return Q(w,R),R}};function r(w){return e==="string"?D(w):e==="boolean"?!!w:w}var c=K(t),_=[],C=0;if(s)for(var M=0;M<s.length;M++){var et=o[n[M]];et?(C===0&&(C=wt()),_[M]=et(s[M])):_[M]=s[M]}var I=c(..._);function Lt(w){return C!==0&&vt(C),r(w)}return I=Lt(I),I},Ut=(t,e,n,s)=>{var l=!n||n.every(r=>r==="number"||r==="boolean"),o=e!=="string";return o&&l&&!s?K(t):(...r)=>Y(t,e,n,r)};if(a.noExitRuntime&&a.noExitRuntime,a.print&&(S=a.print),a.printErr&&(m=a.printErr),a.wasmBinary&&(g=a.wasmBinary),a.arguments&&a.arguments,a.thisProgram&&a.thisProgram,a.preInit)for(typeof a.preInit=="function"&&(a.preInit=[a.preInit]);a.preInit.length>0;)a.preInit.shift()();a.ccall=Y,a.cwrap=Ut,a.setValue=pt,a.getValue=gt,a.writeArrayToMemory=Q;var Z,G,tt,E;function $t(t){a._loadAudio=t.h,a._loadPCMData=t.i,a._getFFTData=t.j,a._getFFTDataAtOffset=t.k,a._getSampleCount=t.l,a._getSampleRate=t.m,a._getChannels=t.n,a._getSamples=t.o,a._cleanup=t.p,a._isSIMDEnabled=t.q,a._malloc=t.r,a._free=t.s,Z=t.t,G=t.u,tt=t.v,E=t.f,t.__indirect_function_table}var Wt={a:At,c:St,d:Pt,e:Tt,b:Dt};function It(){it();function t(){var e;a.calledRun=!0,!v&&(st(),P==null||P(a),(e=a.onRuntimeInitialized)==null||e.call(a),rt())}a.setStatus?(a.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>a.setStatus(""),1),t()},1)):t()}var b;return b=await dt(),It(),L?i=a:i=new Promise((t,e)=>{P=t,h=e}),i}class jt{constructor(){this.audioContext=null,this.source=null,this.analyser=null,this.audioBuffer=null,this.startTime=0,this.pauseTime=0,this._isPlaying=!1,this.frequencyData=null}async loadFile(i){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.audioBuffer=await this.audioContext.decodeAudioData(i),this.analyser||(this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.connect(this.audioContext.destination),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)),console.log(`Audio decoded: ${this.audioBuffer.duration.toFixed(2)}s`)}async loadFromAudioBuffer(i){this.audioBuffer=i,this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.analyser||(this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.connect(this.audioContext.destination),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)),console.log(`Audio loaded: ${i.duration.toFixed(2)}s, ${i.sampleRate}Hz, ${i.numberOfChannels}ch`)}play(){if(!this.audioBuffer)return;this.source&&this.source.stop(),this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.analyser);const i=this.pauseTime;this.source.start(0,i),this.startTime=this.audioContext.currentTime-i,this._isPlaying=!0,this.source.onended=()=>{this._isPlaying&&(this._isPlaying=!1,this.pauseTime=0)}}pause(){!this.source||!this._isPlaying||(this.pauseTime=this.audioContext.currentTime-this.startTime,this.source.stop(),this._isPlaying=!1)}stop(){this.source&&(this.source.stop(),this.pauseTime=0,this._isPlaying=!1)}getFrequencyData(){return this.analyser?(this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyData):null}isPlaying(){return this._isPlaying}getCurrentTime(){return this._isPlaying?this.audioContext.currentTime-this.startTime:this.pauseTime}}class Jt{constructor(i){this.app=i,this.init()}init(){document.getElementById("fft-size").addEventListener("change",u=>{const y=parseInt(u.target.value);this.app.audioPlayer&&this.app.audioPlayer.analyser&&(this.app.audioPlayer.analyser.fftSize=y,this.app.audioPlayer.frequencyData=new Uint8Array(this.app.audioPlayer.analyser.frequencyBinCount),console.log(`FFT size changed to: ${y}`))}),document.getElementById("color-scheme").addEventListener("change",u=>{const y=u.target.value;this.app.visualizer&&this.app.visualizer.setColorScheme(y)});const d=document.getElementById("sensitivity"),f=document.getElementById("sensitivity-value");d.addEventListener("input",u=>{const y=parseFloat(u.target.value);f.textContent=y.toFixed(1),this.app.visualizer&&this.app.visualizer.setSensitivity(y)})}}class nt{constructor(){at(this,"animate",()=>{var i,a;if(requestAnimationFrame(this.animate),this.performanceMonitor.beginFrame(),this.visualizer&&this.visualizer.render(),this.audioPlayer&&this.audioPlayer.isPlaying()){this.performanceMonitor.beginFFT();const d=this.getWasmFrequencyData();if(this.performanceMonitor.endFFT(),d&&this.visualizer){const f=this.wasmFunctions.getSampleRate(),u=((a=(i=this.audioPlayer)==null?void 0:i.analyser)==null?void 0:a.fftSize)||2048;this.visualizer.updateFrequency(d,f,u)}}this.performanceMonitor.endFrame()});this.wasmModule=null,this.audioPlayer=null,this.visualizer=null,this.uiControls=null,this.performanceMonitor=null,this.audioData=null,this.wasmFrequencyData=null,this.avgMagnitudesBuffer=null,this.currentFFTSize=0,this.smoothedFrequencyData=null,this.smoothingFactor=.7,this.smoothedMaxMagnitude=1,this.wasmFunctions={getSampleCount:null,getSampleRate:null,getChannels:null,getSamples:null,loadAudio:null,getBatchFFTData:null,getFFTDataAtOffset:null,getLastFFTTime:null,malloc:null,free:null}}async init(){try{document.getElementById("loading").classList.add("active"),this.updateStatus("WASM 모듈 로딩 중..."),this.wasmModule=await Nt(),console.log("WASM 모듈 로드 완료"),this.cacheWasmFunctions(),this.audioPlayer=new jt,this.visualizer=new xt("canvas-container"),this.uiControls=new Jt(this),this.performanceMonitor=new Ot,this.setupEventListeners(),document.getElementById("loading").classList.remove("active"),this.updateStatus("준비 완료. 오디오 파일을 로드하세요.")}catch(i){console.error("앱 초기화 실패:",i),this.updateStatus("에러: WASM 모듈 로드 실패. 콘솔을 확인하세요.")}}cacheWasmFunctions(){this.wasmFunctions.getSampleCount=this.wasmModule._getSampleCount,this.wasmFunctions.getSampleRate=this.wasmModule._getSampleRate,this.wasmFunctions.getChannels=this.wasmModule._getChannels,this.wasmFunctions.getSamples=this.wasmModule._getSamples,this.wasmFunctions.loadAudio=this.wasmModule._loadAudio,this.wasmFunctions.getBatchFFTData=this.wasmModule._getBatchFFTData,this.wasmFunctions.getFFTDataAtOffset=this.wasmModule._getFFTDataAtOffset,this.wasmFunctions.getLastFFTTime=this.wasmModule._getLastFFTTime,this.wasmFunctions.malloc=this.wasmModule._malloc,this.wasmFunctions.free=this.wasmModule._free}setupEventListeners(){document.getElementById("audio-file").addEventListener("change",a=>this.handleFileSelect(a)),document.getElementById("play-pause-btn").addEventListener("click",()=>this.togglePlayPause()),document.getElementById("stop-btn").addEventListener("click",()=>this.stop()),this.animate()}async handleFileSelect(i){const a=i.target.files[0];if(a)try{this.updateStatus(`${a.name} 로딩 중...`),console.log(`파일 로드 중: ${a.name}, 타입: ${a.type}, 크기: ${a.size} bytes`);const d=await a.arrayBuffer();console.log(`ArrayBuffer 로드 완료, 크기: ${d.byteLength} bytes`),this.updateStatus(`${a.name} 디코딩 중...`),console.log("WASM audio_decoder로 디코딩 중...");const f=new Uint8Array(d),u=this.wasmFunctions.malloc(f.length);new Uint8Array(this.wasmModule.HEAPU8.buffer,u,f.length).set(f);const S=this.wasmFunctions.loadAudio(u,f.length);if(this.wasmFunctions.free(u),!S)throw new Error(`${a.name} 디코딩 실패. WAV 파일만 지원됩니다.`);const m=this.wasmFunctions.getSampleCount(),g=this.wasmFunctions.getSampleRate(),v=this.wasmFunctions.getChannels();console.log(`✓ 디코딩 완료: ${a.name}, ${m} 샘플, ${g}Hz, ${v}채널`),this.updateStatus("AudioBuffer 생성 중...");const P=await this.createAudioBufferFromWasm(m,g,v);console.log("✓ AudioBuffer 생성 완료"),await this.audioPlayer.loadFromAudioBuffer(P),document.getElementById("play-pause-btn").disabled=!1,document.getElementById("stop-btn").disabled=!1,this.updateStatus(`로드 완료: ${a.name} (${g} Hz, ${v}채널)`)}catch(d){console.error("파일 로드 에러:",d),this.updateStatus(`에러: ${d.message}`)}}async createAudioBufferFromWasm(i,a,d){const f=this.wasmFunctions.getSamples();if(!f)throw new Error("WASM에서 샘플을 가져올 수 없습니다");this.audioPlayer.audioContext||(this.audioPlayer.audioContext=new(window.AudioContext||window.webkitAudioContext));const u=this.audioPlayer.audioContext.createBuffer(d,i,a),y=f/4,S=this.wasmModule.HEAPF32;for(let m=0;m<d;m++){const g=u.getChannelData(m);for(let v=0;v<i;v++)g[v]=S[y+v*d+m]}return console.log("✓ AudioBuffer 생성 완료 (WASM PCM → AudioBuffer)"),u}togglePlayPause(){if(!this.audioPlayer)return;const i=document.getElementById("play-pause-btn");this.audioPlayer.isPlaying()?(this.audioPlayer.pause(),this.updateStatus("일시정지"),this.performanceMonitor.pause(),i.textContent="▶ 재생"):(this.audioPlayer.play(),this.updateStatus("재생 중..."),this.performanceMonitor.start(),i.textContent="⏸ 일시정지")}stop(){if(this.audioPlayer){this.audioPlayer.stop(),this.updateStatus("정지"),this.performanceMonitor.stop();const i=document.getElementById("play-pause-btn");i.textContent="▶ 재생"}}getWasmFrequencyData(){if(!this.wasmModule||!this.audioPlayer)return null;const i=this.audioPlayer.getCurrentTime(),a=this.wasmFunctions.getSampleRate(),d=Math.floor(i*a),f=this.audioPlayer.analyser?this.audioPlayer.analyser.fftSize:2048,u=f/2;this.currentFFTSize!==f&&(this.currentFFTSize=f,this.wasmFrequencyData=new Uint8Array(u),this.avgMagnitudesBuffer=new Float32Array(u),this.smoothedFrequencyData=new Uint8Array(u));const y=this.wasmFunctions.getFFTDataAtOffset(d,f);if(!y)return this.audioPlayer.getFrequencyData();if(this.wasmFunctions.getLastFFTTime){const h=this.wasmFunctions.getLastFFTTime();h>0&&this.performanceMonitor&&this.performanceMonitor.setPureWasmFftTime(h)}const S=y/4,m=this.wasmModule.HEAPF32;(!this.wasmFrequencyData||this.wasmFrequencyData.length!==u)&&(this.wasmFrequencyData=new Uint8Array(u));let g=0;for(let h=0;h<u;h++){const p=m[S+h];p>g&&(g=p)}this.smoothedMaxMagnitude=this.smoothedMaxMagnitude*.9+g*.1;const v=this.smoothedMaxMagnitude>0?255/this.smoothedMaxMagnitude:0;for(let h=0;h<u;h++){const p=m[S+h];this.wasmFrequencyData[h]=Math.min(255,Math.floor(p*v))}const P=1-this.smoothingFactor;for(let h=0;h<u;h++)this.smoothedFrequencyData[h]=Math.floor(this.smoothedFrequencyData[h]*this.smoothingFactor+this.wasmFrequencyData[h]*P);return this.smoothedFrequencyData}updateStatus(i){document.getElementById("status").textContent=i}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new nt().init()}):new nt().init();
