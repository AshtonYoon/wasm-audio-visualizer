var qt=Object.defineProperty;var Ot=(A,i,a)=>i in A?qt(A,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):A[i]=a;var at=(A,i,a)=>Ot(A,typeof i!="symbol"?i+"":i,a);import{V as Vt,P as Nt}from"./performance-monitor-C4boWBfy.js";import{A as jt,U as Jt}from"./ui-controls-BCSh0n8g.js";async function Kt(A={}){var i,a=A,d=import.meta.url,l="";function g(t){return a.locateFile?a.locateFile(t,l):l+t}var v;{try{l=new URL(".",d).href}catch{}v=async t=>{var e=await fetch(t,{credentials:"same-origin"});if(e.ok)return e.arrayBuffer();throw new Error(e.status+" : "+e.url)}}var m=console.log.bind(console),y=console.error.bind(console),h,M=!1,_,R,u,P,b,k,p,$,z,L,H=!1;function q(){var t=W.buffer;a.HEAP8=u=new Int8Array(t),b=new Int16Array(t),a.HEAPU8=P=new Uint8Array(t),k=new Int32Array(t),p=new Uint32Array(t),a.HEAPF32=$=new Float32Array(t),z=new Float64Array(t),L=new BigInt64Array(t),new BigUint64Array(t)}function rt(){if(a.preRun)for(typeof a.preRun=="function"&&(a.preRun=[a.preRun]);a.preRun.length;)gt(a.preRun.shift());O(N)}function it(){H=!0,D.g()}function st(){if(a.postRun)for(typeof a.postRun=="function"&&(a.postRun=[a.postRun]);a.postRun.length;)mt(a.postRun.shift());O(V)}function T(t){var n;(n=a.onAbort)==null||n.call(a,t),t="Aborted("+t+")",y(t),M=!0,t+=". Build with -sASSERTIONS for more info.";var e=new WebAssembly.RuntimeError(t);throw R==null||R(e),e}var U;function ot(){return a.locateFile?g("audio-visualizer.wasm"):new URL("/audio-visualizer.wasm",import.meta.url).href}function lt(t){if(t==U&&h)return new Uint8Array(h);throw"both async and sync fetching of the wasm failed"}async function ut(t){if(!h)try{var e=await v(t);return new Uint8Array(e)}catch{}return lt(t)}async function ct(t,e){try{var n=await ut(t),r=await WebAssembly.instantiate(n,e);return r}catch(c){y(`failed to asynchronously prepare wasm: ${c}`),T(c)}}async function ft(t,e,n){if(!t)try{var r=fetch(e,{credentials:"same-origin"}),c=await WebAssembly.instantiateStreaming(r,n);return c}catch(o){y(`wasm streaming compile failed: ${o}`),y("falling back to ArrayBuffer instantiation")}return ct(e,n)}function dt(){var t={a:Ut};return t}async function ht(){function t(o,s){return D=o.exports,Lt(D),q(),D}function e(o){return t(o.instance)}var n=dt();if(a.instantiateWasm)return new Promise((o,s)=>{a.instantiateWasm(n,(f,w)=>{o(t(f))})});U??(U=ot());var r=await ft(h,U,n),c=e(r);return c}var O=t=>{for(;t.length>0;)t.shift()(a)},V=[],mt=t=>V.push(t),N=[],gt=t=>N.push(t);function vt(t,e="i8"){switch(e.endsWith("*")&&(e="*"),e){case"i1":return u[t];case"i8":return u[t];case"i16":return b[t>>1];case"i32":return k[t>>2];case"i64":return L[t>>3];case"float":return $[t>>2];case"double":return z[t>>3];case"*":return p[t>>2];default:T(`invalid type for getValue: ${e}`)}}function yt(t,e,n="i8"){switch(n.endsWith("*")&&(n="*"),n){case"i1":u[t]=e;break;case"i8":u[t]=e;break;case"i16":b[t>>1]=e;break;case"i32":k[t>>2]=e;break;case"i64":L[t>>3]=BigInt(e);break;case"float":$[t>>2]=e;break;case"double":z[t>>3]=e;break;case"*":p[t>>2]=e;break;default:T(`invalid type for setValue: ${n}`)}}var Ft=t=>G(t),pt=()=>tt(),j=globalThis.TextDecoder&&new TextDecoder,wt=(t,e,n,r)=>{for(var c=e+n;t[e]&&!(e>=c);)++e;return e},J=(t,e=0,n,r)=>{var c=wt(t,e,n);if(c-e>16&&t.buffer&&j)return j.decode(t.subarray(e,c));for(var o="";e<c;){var s=t[e++];if(!(s&128)){o+=String.fromCharCode(s);continue}var f=t[e++]&63;if((s&224)==192){o+=String.fromCharCode((s&31)<<6|f);continue}var w=t[e++]&63;if((s&240)==224?s=(s&15)<<12|f<<6|w:s=(s&7)<<18|f<<12|w<<6|t[e++]&63,s<65536)o+=String.fromCharCode(s);else{var S=s-65536;o+=String.fromCharCode(55296|S>>10,56320|S&1023)}}return o},E=(t,e,n)=>t?J(P,t,e):"",At=(t,e,n,r)=>T(`Assertion failed: ${E(t)}, at: `+[e?E(e):"unknown filename",n,r?E(r):"unknown function"]);class Mt{constructor(e){this.excPtr=e,this.ptr=e-24}set_type(e){p[this.ptr+4>>2]=e}get_type(){return p[this.ptr+4>>2]}set_destructor(e){p[this.ptr+8>>2]=e}get_destructor(){return p[this.ptr+8>>2]}set_caught(e){e=e?1:0,u[this.ptr+12]=e}get_caught(){return u[this.ptr+12]!=0}set_rethrown(e){e=e?1:0,u[this.ptr+13]=e}get_rethrown(){return u[this.ptr+13]!=0}init(e,n){this.set_adjusted_ptr(0),this.set_type(e),this.set_destructor(n)}set_adjusted_ptr(e){p[this.ptr+16>>2]=e}get_adjusted_ptr(){return p[this.ptr+16>>2]}}var K=0,_t=(t,e,n)=>{var r=new Mt(t);throw r.init(e,n),K=t,K},bt=()=>T(""),Pt=()=>536870912,St=(t,e)=>Math.ceil(t/e)*e,Ct=t=>{var e=W.buffer.byteLength,n=(t-e+65535)/65536|0;try{return W.grow(n),q(),1}catch{}},Rt=t=>{var e=P.length;t>>>=0;var n=Pt();if(t>n)return!1;for(var r=1;r<=4;r*=2){var c=e*(1+.2/r);c=Math.min(c,t+100663296);var o=Math.min(n,St(Math.max(t,c),65536)),s=Ct(o);if(s)return!0}return!1},Tt=[null,[],[]],Dt=(t,e)=>{var n=Tt[t];e===0||e===10?((t===1?m:y)(J(n)),n.length=0):n.push(e)},Bt=(t,e,n,r)=>{for(var c=0,o=0;o<n;o++){var s=p[e>>2],f=p[e+4>>2];e+=8;for(var w=0;w<f;w++)Dt(t,P[s+w]);c+=f}return p[r>>2]=c,0},Q=t=>{var e=a["_"+t];return e},X=(t,e)=>{u.set(t,e)},Et=t=>{for(var e=0,n=0;n<t.length;++n){var r=t.charCodeAt(n);r<=127?e++:r<=2047?e+=2:r>=55296&&r<=57343?(e+=4,++n):e+=3}return e},Wt=(t,e,n,r)=>{if(!(r>0))return 0;for(var c=n,o=n+r-1,s=0;s<t.length;++s){var f=t.codePointAt(s);if(f<=127){if(n>=o)break;e[n++]=f}else if(f<=2047){if(n+1>=o)break;e[n++]=192|f>>6,e[n++]=128|f&63}else if(f<=65535){if(n+2>=o)break;e[n++]=224|f>>12,e[n++]=128|f>>6&63,e[n++]=128|f&63}else{if(n+3>=o)break;e[n++]=240|f>>18,e[n++]=128|f>>12&63,e[n++]=128|f>>6&63,e[n++]=128|f&63,s++}}return e[n]=0,n-c},kt=(t,e,n)=>Wt(t,P,e,n),Y=t=>x(t),$t=t=>{var e=Et(t)+1,n=Y(e);return kt(t,n,e),n},Z=(t,e,n,r,c)=>{var o={string:F=>{var B=0;return F!=null&&F!==0&&(B=$t(F)),B},array:F=>{var B=Y(F.length);return X(F,B),B}};function s(F){return e==="string"?E(F):e==="boolean"?!!F:F}var f=Q(t),w=[],S=0;if(r)for(var C=0;C<r.length;C++){var et=o[n[C]];et?(S===0&&(S=pt()),w[C]=et(r[C])):w[C]=r[C]}var I=f(...w);function Ht(F){return S!==0&&Ft(S),s(F)}return I=Ht(I),I},zt=(t,e,n,r)=>{var c=!n||n.every(s=>s==="number"||s==="boolean"),o=e!=="string";return o&&c&&!r?Q(t):(...s)=>Z(t,e,n,s)};if(a.noExitRuntime&&a.noExitRuntime,a.print&&(m=a.print),a.printErr&&(y=a.printErr),a.wasmBinary&&(h=a.wasmBinary),a.arguments&&a.arguments,a.thisProgram&&a.thisProgram,a.preInit)for(typeof a.preInit=="function"&&(a.preInit=[a.preInit]);a.preInit.length>0;)a.preInit.shift()();a.ccall=Z,a.cwrap=zt,a.setValue=yt,a.getValue=vt,a.writeArrayToMemory=X;var G,x,tt,W;function Lt(t){a._loadAudio=t.h,a._loadPCMData=t.i,a._getFFTData=t.j,a._getFFTDataAtOffset=t.k,a._getSampleCount=t.l,a._getSampleRate=t.m,a._getChannels=t.n,a._cleanup=t.o,a._malloc=t.p,a._free=t.q,G=t.r,x=t.s,tt=t.t,W=t.f,t.__indirect_function_table}var Ut={a:At,c:_t,d:bt,e:Rt,b:Bt};function It(){rt();function t(){var e;a.calledRun=!0,!M&&(it(),_==null||_(a),(e=a.onRuntimeInitialized)==null||e.call(a),st())}a.setStatus?(a.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>a.setStatus(""),1),t()},1)):t()}var D;return D=await ht(),It(),H?i=a:i=new Promise((t,e)=>{_=t,R=e}),i}class nt{constructor(){at(this,"animate",()=>{if(requestAnimationFrame(this.animate),this.performanceMonitor.beginFrame(),this.visualizer&&this.visualizer.render(),this.audioPlayer&&this.audioPlayer.isPlaying()){this.performanceMonitor.beginFFT();const i=this.getWasmFrequencyData();this.performanceMonitor.endFFT(),i&&this.visualizer&&this.visualizer.updateFrequency(i)}this.performanceMonitor.endFrame()});this.wasmModule=null,this.audioPlayer=null,this.visualizer=null,this.uiControls=null,this.performanceMonitor=null,this.audioData=null,this.wasmFrequencyData=null,this.avgMagnitudesBuffer=null,this.currentFFTSize=0,this.wasmFunctions={getSampleCount:null,getSampleRate:null,getChannels:null,getBatchFFTData:null,getFFTDataAtOffset:null,malloc:null,free:null,loadPCMData:null}}async init(){try{document.getElementById("loading").classList.add("active"),this.updateStatus("Loading WASM module..."),this.wasmModule=await Kt(),console.log("WASM module loaded successfully"),this.cacheWasmFunctions(),this.audioPlayer=new jt,this.visualizer=new Vt("canvas-container"),this.uiControls=new Jt(this),this.performanceMonitor=new Nt,this.setupEventListeners(),document.getElementById("loading").classList.remove("active"),this.updateStatus("Ready. Load an audio file to begin.")}catch(i){console.error("Failed to initialize app:",i),this.updateStatus("Error: Failed to load WASM module. Check console for details.")}}cacheWasmFunctions(){this.wasmFunctions.getSampleCount=this.wasmModule._getSampleCount,this.wasmFunctions.getSampleRate=this.wasmModule._getSampleRate,this.wasmFunctions.getChannels=this.wasmModule._getChannels,this.wasmFunctions.getBatchFFTData=this.wasmModule._getBatchFFTData,this.wasmFunctions.getFFTDataAtOffset=this.wasmModule._getFFTDataAtOffset,this.wasmFunctions.malloc=this.wasmModule._malloc,this.wasmFunctions.free=this.wasmModule._free,this.wasmFunctions.loadPCMData=this.wasmModule._loadPCMData}setupEventListeners(){document.getElementById("audio-file").addEventListener("change",a=>this.handleFileSelect(a)),document.getElementById("play-btn").addEventListener("click",()=>this.play()),document.getElementById("pause-btn").addEventListener("click",()=>this.pause()),document.getElementById("stop-btn").addEventListener("click",()=>this.stop()),this.animate()}async handleFileSelect(i){const a=i.target.files[0];if(a)try{this.updateStatus(`Loading ${a.name}...`),console.log(`Loading file: ${a.name}, type: ${a.type}, size: ${a.size} bytes`);const d=await a.arrayBuffer();console.log(`ArrayBuffer loaded, size: ${d.byteLength} bytes`),this.audioPlayer.audioContext||(this.audioPlayer.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.updateStatus(`Decoding ${a.name}...`),console.log("Decoding with Web Audio API...");let l;try{l=await this.audioPlayer.audioContext.decodeAudioData(d.slice(0))}catch(h){throw console.error("Web Audio API decode error:",h),new Error(`Failed to decode ${a.name}. Format may not be supported by your browser.`)}if(console.log(`✓ Decoded: ${a.name}, ${l.duration.toFixed(2)}s, ${l.sampleRate}Hz, ${l.numberOfChannels}ch`),this.updateStatus("Loading to WASM..."),!this.loadPCMToWasm(l))throw new Error("Failed to load audio data to WASM visualization engine.");console.log("✓ PCM data loaded to WASM");const v=this.wasmFunctions.getSampleCount(),m=this.wasmFunctions.getSampleRate(),y=this.wasmFunctions.getChannels();console.log(`WASM loaded: ${v} samples, ${m} Hz, ${y} ch`),await this.audioPlayer.loadFromAudioBuffer(l),document.getElementById("play-btn").disabled=!1,document.getElementById("pause-btn").disabled=!1,document.getElementById("stop-btn").disabled=!1,this.updateStatus(`Loaded: ${a.name} (${m} Hz, ${y}ch)`)}catch(d){console.error("Error loading file:",d),this.updateStatus(`Error: ${d.message}`)}}loadPCMToWasm(i){try{console.log("Loading PCM to WASM...");const a=i.getChannelData(0),d=a.length;console.log(`PCM data: ${d} samples, ${i.sampleRate}Hz, ${i.numberOfChannels}ch`);const l=this.wasmFunctions.malloc(d*4);console.log(`Allocated ${d*4} bytes at pointer ${l}`);const g=l/4;for(let m=0;m<d;m++)this.wasmModule.HEAPF32[g+m]=a[m];console.log("PCM data copied to WASM memory");const v=this.wasmFunctions.loadPCMData(l,d,i.sampleRate,i.numberOfChannels);return console.log(`WASM _loadPCMData returned: ${v}`),this.wasmFunctions.free(l),v===1}catch(a){return console.error("Error loading PCM to WASM:",a),!1}}play(){this.audioPlayer&&(this.audioPlayer.play(),this.updateStatus("Playing..."),this.performanceMonitor.start())}pause(){this.audioPlayer&&(this.audioPlayer.pause(),this.updateStatus("Paused"),this.performanceMonitor.pause())}stop(){this.audioPlayer&&(this.audioPlayer.stop(),this.updateStatus("Stopped"),this.performanceMonitor.stop())}getWasmFrequencyData(){if(!this.wasmModule||!this.audioPlayer)return null;const i=this.audioPlayer.getCurrentTime(),a=this.wasmFunctions.getSampleRate(),d=Math.floor(i*a),l=this.audioPlayer.analyser?this.audioPlayer.analyser.fftSize:2048,g=l/2;this.currentFFTSize!==l&&(this.currentFFTSize=l,this.wasmFrequencyData=new Uint8Array(g),this.avgMagnitudesBuffer=new Float32Array(g));const v=4,m=Math.floor(l/4);if(this.wasmFunctions.getBatchFFTData){const y=this.wasmFunctions.getBatchFFTData(d,v,m,l);if(!y)return console.warn("Batch FFT failed, falling back to single FFT"),this.getSingleWasmFFT(d,l,g);const h=y/4,M=this.wasmModule.HEAPF32;this.avgMagnitudesBuffer.fill(0);for(let u=0;u<v;u++){const P=h+u*g;for(let b=0;b<g;b++)this.avgMagnitudesBuffer[b]+=M[P+b]}let _=0;for(let u=0;u<g;u++)this.avgMagnitudesBuffer[u]/=v,this.avgMagnitudesBuffer[u]>_&&(_=this.avgMagnitudesBuffer[u]);const R=_>0?255/_:0;for(let u=0;u<g;u++)this.wasmFrequencyData[u]=Math.min(255,Math.floor(this.avgMagnitudesBuffer[u]*R));return this.wasmFrequencyData}else return console.warn("Batch FFT not available, using single FFT"),this.getSingleWasmFFT(d,l,g)}getSingleWasmFFT(i,a,d){const l=this.wasmFunctions.getFFTDataAtOffset(i,a);if(!l)return this.audioPlayer.getFrequencyData();const g=l/4,v=this.wasmModule.HEAPF32;(!this.wasmFrequencyData||this.wasmFrequencyData.length!==d)&&(this.wasmFrequencyData=new Uint8Array(d));let m=0;for(let h=0;h<d;h++){const M=v[g+h];M>m&&(m=M)}const y=m>0?255/m:0;for(let h=0;h<d;h++){const M=v[g+h];this.wasmFrequencyData[h]=Math.min(255,Math.floor(M*y))}return this.wasmFrequencyData}updateStatus(i){document.getElementById("status").textContent=i}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new nt().init()}):new nt().init();
