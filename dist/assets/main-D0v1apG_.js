var Lt=Object.defineProperty;var Ot=(w,i,a)=>i in w?Lt(w,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):w[i]=a;var at=(w,i,a)=>Ot(w,typeof i!="symbol"?i+"":i,a);import{V as Vt,P as xt}from"./performance-monitor-Dvt__9VL.js";async function Nt(w={}){var i,a=w,c=import.meta.url,o="";function d(t){return a.locateFile?a.locateFile(t,o):o+t}var m;{try{o=new URL(".",c).href}catch{}m=async t=>{var e=await fetch(t,{credentials:"same-origin"});if(e.ok)return e.arrayBuffer();throw new Error(e.status+" : "+e.url)}}var y=console.log.bind(console),v=console.error.bind(console),g,P=!1,C,T,l,_,S,$,F,W,k,I,H=!1;function L(){var t=z.buffer;a.HEAP8=l=new Int8Array(t),S=new Int16Array(t),a.HEAPU8=_=new Uint8Array(t),$=new Int32Array(t),F=new Uint32Array(t),a.HEAPF32=W=new Float32Array(t),k=new Float64Array(t),I=new BigInt64Array(t),new BigUint64Array(t)}function it(){if(a.preRun)for(typeof a.preRun=="function"&&(a.preRun=[a.preRun]);a.preRun.length;)gt(a.preRun.shift());O(x)}function st(){H=!0,D.g()}function rt(){if(a.postRun)for(typeof a.postRun=="function"&&(a.postRun=[a.postRun]);a.postRun.length;)mt(a.postRun.shift());O(V)}function B(t){var n;(n=a.onAbort)==null||n.call(a,t),t="Aborted("+t+")",v(t),P=!0,t+=". Build with -sASSERTIONS for more info.";var e=new WebAssembly.RuntimeError(t);throw T==null||T(e),e}var q;function ot(){return a.locateFile?d("audio-visualizer.wasm"):new URL("/audio-visualizer.wasm",import.meta.url).href}function ut(t){if(t==q&&g)return new Uint8Array(g);throw"both async and sync fetching of the wasm failed"}async function lt(t){if(!g)try{var e=await m(t);return new Uint8Array(e)}catch{}return ut(t)}async function ct(t,e){try{var n=await lt(t),s=await WebAssembly.instantiate(n,e);return s}catch(f){v(`failed to asynchronously prepare wasm: ${f}`),B(f)}}async function ft(t,e,n){if(!t)try{var s=fetch(e,{credentials:"same-origin"}),f=await WebAssembly.instantiateStreaming(s,n);return f}catch(u){v(`wasm streaming compile failed: ${u}`),v("falling back to ArrayBuffer instantiation")}return ct(e,n)}function ht(){var t={a:qt};return t}async function dt(){function t(u,r){return D=u.exports,It(D),L(),D}function e(u){return t(u.instance)}var n=ht();if(a.instantiateWasm)return new Promise((u,r)=>{a.instantiateWasm(n,(h,A)=>{u(t(h))})});q??(q=ot());var s=await ft(g,q,n),f=e(s);return f}var O=t=>{for(;t.length>0;)t.shift()(a)},V=[],mt=t=>V.push(t),x=[],gt=t=>x.push(t);function yt(t,e="i8"){switch(e.endsWith("*")&&(e="*"),e){case"i1":return l[t];case"i8":return l[t];case"i16":return S[t>>1];case"i32":return $[t>>2];case"i64":return I[t>>3];case"float":return W[t>>2];case"double":return k[t>>3];case"*":return F[t>>2];default:B(`invalid type for getValue: ${e}`)}}function vt(t,e,n="i8"){switch(n.endsWith("*")&&(n="*"),n){case"i1":l[t]=e;break;case"i8":l[t]=e;break;case"i16":S[t>>1]=e;break;case"i32":$[t>>2]=e;break;case"i64":I[t>>3]=BigInt(e);break;case"float":W[t>>2]=e;break;case"double":k[t>>3]=e;break;case"*":F[t>>2]=e;break;default:B(`invalid type for setValue: ${n}`)}}var pt=t=>Z(t),wt=()=>tt(),N=globalThis.TextDecoder&&new TextDecoder,Ft=(t,e,n,s)=>{for(var f=e+n;t[e]&&!(e>=f);)++e;return e},j=(t,e=0,n,s)=>{var f=Ft(t,e,n);if(f-e>16&&t.buffer&&N)return N.decode(t.subarray(e,f));for(var u="";e<f;){var r=t[e++];if(!(r&128)){u+=String.fromCharCode(r);continue}var h=t[e++]&63;if((r&224)==192){u+=String.fromCharCode((r&31)<<6|h);continue}var A=t[e++]&63;if((r&240)==224?r=(r&15)<<12|h<<6|A:r=(r&7)<<18|h<<12|A<<6|t[e++]&63,r<65536)u+=String.fromCharCode(r);else{var M=r-65536;u+=String.fromCharCode(55296|M>>10,56320|M&1023)}}return u},E=(t,e,n)=>t?j(_,t,e):"",At=(t,e,n,s)=>B(`Assertion failed: ${E(t)}, at: `+[e?E(e):"unknown filename",n,s?E(s):"unknown function"]);class Pt{constructor(e){this.excPtr=e,this.ptr=e-24}set_type(e){F[this.ptr+4>>2]=e}get_type(){return F[this.ptr+4>>2]}set_destructor(e){F[this.ptr+8>>2]=e}get_destructor(){return F[this.ptr+8>>2]}set_caught(e){e=e?1:0,l[this.ptr+12]=e}get_caught(){return l[this.ptr+12]!=0}set_rethrown(e){e=e?1:0,l[this.ptr+13]=e}get_rethrown(){return l[this.ptr+13]!=0}init(e,n){this.set_adjusted_ptr(0),this.set_type(e),this.set_destructor(n)}set_adjusted_ptr(e){F[this.ptr+16>>2]=e}get_adjusted_ptr(){return F[this.ptr+16>>2]}}var J=0,Ct=(t,e,n)=>{var s=new Pt(t);throw s.init(e,n),J=t,J},St=()=>B(""),_t=()=>536870912,Mt=(t,e)=>Math.ceil(t/e)*e,bt=t=>{var e=z.buffer.byteLength,n=(t-e+65535)/65536|0;try{return z.grow(n),L(),1}catch{}},Tt=t=>{var e=_.length;t>>>=0;var n=_t();if(t>n)return!1;for(var s=1;s<=4;s*=2){var f=e*(1+.2/s);f=Math.min(f,t+100663296);var u=Math.min(n,Mt(Math.max(t,f),65536)),r=bt(u);if(r)return!0}return!1},Bt=[null,[],[]],Dt=(t,e)=>{var n=Bt[t];e===0||e===10?((t===1?y:v)(j(n)),n.length=0):n.push(e)},Rt=(t,e,n,s)=>{for(var f=0,u=0;u<n;u++){var r=F[e>>2],h=F[e+4>>2];e+=8;for(var A=0;A<h;A++)Dt(t,_[r+A]);f+=h}return F[s>>2]=f,0},K=t=>{var e=a["_"+t];return e},Q=(t,e)=>{l.set(t,e)},Et=t=>{for(var e=0,n=0;n<t.length;++n){var s=t.charCodeAt(n);s<=127?e++:s<=2047?e+=2:s>=55296&&s<=57343?(e+=4,++n):e+=3}return e},zt=(t,e,n,s)=>{if(!(s>0))return 0;for(var f=n,u=n+s-1,r=0;r<t.length;++r){var h=t.codePointAt(r);if(h<=127){if(n>=u)break;e[n++]=h}else if(h<=2047){if(n+1>=u)break;e[n++]=192|h>>6,e[n++]=128|h&63}else if(h<=65535){if(n+2>=u)break;e[n++]=224|h>>12,e[n++]=128|h>>6&63,e[n++]=128|h&63}else{if(n+3>=u)break;e[n++]=240|h>>18,e[n++]=128|h>>12&63,e[n++]=128|h>>6&63,e[n++]=128|h&63,r++}}return e[n]=0,n-f},$t=(t,e,n)=>zt(t,_,e,n),X=t=>G(t),Wt=t=>{var e=Et(t)+1,n=X(e);return $t(t,n,e),n},Y=(t,e,n,s,f)=>{var u={string:p=>{var R=0;return p!=null&&p!==0&&(R=Wt(p)),R},array:p=>{var R=X(p.length);return Q(p,R),R}};function r(p){return e==="string"?E(p):e==="boolean"?!!p:p}var h=K(t),A=[],M=0;if(s)for(var b=0;b<s.length;b++){var et=u[n[b]];et?(M===0&&(M=wt()),A[b]=et(s[b])):A[b]=s[b]}var U=h(...A);function Ht(p){return M!==0&&pt(M),r(p)}return U=Ht(U),U},kt=(t,e,n,s)=>{var f=!n||n.every(r=>r==="number"||r==="boolean"),u=e!=="string";return u&&f&&!s?K(t):(...r)=>Y(t,e,n,r)};if(a.noExitRuntime&&a.noExitRuntime,a.print&&(y=a.print),a.printErr&&(v=a.printErr),a.wasmBinary&&(g=a.wasmBinary),a.arguments&&a.arguments,a.thisProgram&&a.thisProgram,a.preInit)for(typeof a.preInit=="function"&&(a.preInit=[a.preInit]);a.preInit.length>0;)a.preInit.shift()();a.ccall=Y,a.cwrap=kt,a.setValue=vt,a.getValue=yt,a.writeArrayToMemory=Q;var Z,G,tt,z;function It(t){a._loadAudio=t.h,a._loadPCMData=t.i,a._getFFTData=t.j,a._getFFTDataAtOffset=t.k,a._getSampleCount=t.l,a._getSampleRate=t.m,a._getChannels=t.n,a._cleanup=t.o,a._malloc=t.p,a._free=t.q,Z=t.r,G=t.s,tt=t.t,z=t.f,t.__indirect_function_table}var qt={a:At,c:Ct,d:St,e:Tt,b:Rt};function Ut(){it();function t(){var e;a.calledRun=!0,!P&&(st(),C==null||C(a),(e=a.onRuntimeInitialized)==null||e.call(a),rt())}a.setStatus?(a.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>a.setStatus(""),1),t()},1)):t()}var D;return D=await dt(),Ut(),H?i=a:i=new Promise((t,e)=>{C=t,T=e}),i}class jt{constructor(){this.audioContext=null,this.source=null,this.analyser=null,this.audioBuffer=null,this.startTime=0,this.pauseTime=0,this._isPlaying=!1,this.frequencyData=null}async loadFile(i){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.audioBuffer=await this.audioContext.decodeAudioData(i),this.analyser||(this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.connect(this.audioContext.destination),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)),console.log(`Audio decoded: ${this.audioBuffer.duration.toFixed(2)}s`)}async loadFromAudioBuffer(i){this.audioBuffer=i,this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.analyser||(this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.connect(this.audioContext.destination),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)),console.log(`Audio loaded: ${i.duration.toFixed(2)}s, ${i.sampleRate}Hz, ${i.numberOfChannels}ch`)}play(){if(!this.audioBuffer)return;this.source&&this.source.stop(),this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.analyser);const i=this.pauseTime;this.source.start(0,i),this.startTime=this.audioContext.currentTime-i,this._isPlaying=!0,this.source.onended=()=>{this._isPlaying&&(this._isPlaying=!1,this.pauseTime=0)}}pause(){!this.source||!this._isPlaying||(this.pauseTime=this.audioContext.currentTime-this.startTime,this.source.stop(),this._isPlaying=!1)}stop(){this.source&&(this.source.stop(),this.pauseTime=0,this._isPlaying=!1)}getFrequencyData(){return this.analyser?(this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyData):null}isPlaying(){return this._isPlaying}getCurrentTime(){return this._isPlaying?this.audioContext.currentTime-this.startTime:this.pauseTime}}class Jt{constructor(i){this.app=i,this.init()}init(){document.getElementById("fft-size").addEventListener("change",d=>{const m=parseInt(d.target.value);this.app.audioPlayer&&this.app.audioPlayer.analyser&&(this.app.audioPlayer.analyser.fftSize=m,this.app.audioPlayer.frequencyData=new Uint8Array(this.app.audioPlayer.analyser.frequencyBinCount),console.log(`FFT size changed to: ${m}`))}),document.getElementById("color-scheme").addEventListener("change",d=>{const m=d.target.value;this.app.visualizer&&this.app.visualizer.setColorScheme(m)});const c=document.getElementById("sensitivity"),o=document.getElementById("sensitivity-value");c.addEventListener("input",d=>{const m=parseFloat(d.target.value);o.textContent=m.toFixed(1),this.app.visualizer&&this.app.visualizer.setSensitivity(m)})}}class nt{constructor(){at(this,"animate",()=>{if(requestAnimationFrame(this.animate),this.performanceMonitor.beginFrame(),this.visualizer&&this.visualizer.render(),this.audioPlayer&&this.audioPlayer.isPlaying()){this.performanceMonitor.beginFFT();const i=this.getWasmFrequencyData();this.performanceMonitor.endFFT(),i&&this.visualizer&&this.visualizer.updateFrequency(i)}this.performanceMonitor.endFrame()});this.wasmModule=null,this.audioPlayer=null,this.visualizer=null,this.uiControls=null,this.performanceMonitor=null,this.audioData=null,this.wasmFrequencyData=null,this.avgMagnitudesBuffer=null,this.currentFFTSize=0,this.wasmFunctions={getSampleCount:null,getSampleRate:null,getChannels:null,getBatchFFTData:null,getFFTDataAtOffset:null,malloc:null,free:null,loadPCMData:null}}async init(){try{document.getElementById("loading").classList.add("active"),this.updateStatus("WASM 모듈 로딩 중..."),this.wasmModule=await Nt(),console.log("WASM 모듈 로드 완료"),this.cacheWasmFunctions(),this.audioPlayer=new jt,this.visualizer=new Vt("canvas-container"),this.uiControls=new Jt(this),this.performanceMonitor=new xt,this.setupEventListeners(),document.getElementById("loading").classList.remove("active"),this.updateStatus("준비 완료. 오디오 파일을 로드하세요.")}catch(i){console.error("앱 초기화 실패:",i),this.updateStatus("에러: WASM 모듈 로드 실패. 콘솔을 확인하세요.")}}cacheWasmFunctions(){this.wasmFunctions.getSampleCount=this.wasmModule._getSampleCount,this.wasmFunctions.getSampleRate=this.wasmModule._getSampleRate,this.wasmFunctions.getChannels=this.wasmModule._getChannels,this.wasmFunctions.getBatchFFTData=this.wasmModule._getBatchFFTData,this.wasmFunctions.getFFTDataAtOffset=this.wasmModule._getFFTDataAtOffset,this.wasmFunctions.malloc=this.wasmModule._malloc,this.wasmFunctions.free=this.wasmModule._free,this.wasmFunctions.loadPCMData=this.wasmModule._loadPCMData}setupEventListeners(){document.getElementById("audio-file").addEventListener("change",a=>this.handleFileSelect(a)),document.getElementById("play-pause-btn").addEventListener("click",()=>this.togglePlayPause()),document.getElementById("stop-btn").addEventListener("click",()=>this.stop()),this.animate()}async handleFileSelect(i){const a=i.target.files[0];if(a)try{this.updateStatus(`${a.name} 로딩 중...`),console.log(`파일 로드 중: ${a.name}, 타입: ${a.type}, 크기: ${a.size} bytes`);const c=await a.arrayBuffer();console.log(`ArrayBuffer 로드 완료, 크기: ${c.byteLength} bytes`),this.audioPlayer.audioContext||(this.audioPlayer.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.updateStatus(`${a.name} 디코딩 중...`),console.log("Web Audio API로 디코딩 중...");let o;try{o=await this.audioPlayer.audioContext.decodeAudioData(c.slice(0))}catch(g){throw console.error("Web Audio API 디코드 에러:",g),new Error(`${a.name} 디코딩 실패. 브라우저에서 지원하지 않는 포맷일 수 있습니다.`)}if(console.log(`✓ 디코딩 완료: ${a.name}, ${o.duration.toFixed(2)}초, ${o.sampleRate}Hz, ${o.numberOfChannels}채널`),this.updateStatus("WASM에 로딩 중..."),!this.loadPCMToWasm(o))throw new Error("WASM 시각화 엔진에 오디오 데이터 로드 실패.");console.log("✓ PCM 데이터를 WASM에 로드 완료");const m=this.wasmFunctions.getSampleCount(),y=this.wasmFunctions.getSampleRate(),v=this.wasmFunctions.getChannels();console.log(`WASM 로드 완료: ${m} 샘플, ${y} Hz, ${v} 채널`),await this.audioPlayer.loadFromAudioBuffer(o),document.getElementById("play-pause-btn").disabled=!1,document.getElementById("stop-btn").disabled=!1,this.updateStatus(`로드 완료: ${a.name} (${y} Hz, ${v}채널)`)}catch(c){console.error("파일 로드 에러:",c),this.updateStatus(`에러: ${c.message}`)}}loadPCMToWasm(i){try{console.log("WASM에 PCM 로딩 중...");const a=i.getChannelData(0),c=a.length;console.log(`PCM 데이터: ${c} 샘플, ${i.sampleRate}Hz, ${i.numberOfChannels}채널`);const o=this.wasmFunctions.malloc(c*4);console.log(`포인터 ${o}에 ${c*4} 바이트 할당`);const d=o/4;for(let y=0;y<c;y++)this.wasmModule.HEAPF32[d+y]=a[y];console.log("PCM 데이터를 WASM 메모리에 복사 완료");const m=this.wasmFunctions.loadPCMData(o,c,i.sampleRate,i.numberOfChannels);return console.log(`WASM _loadPCMData 반환값: ${m}`),this.wasmFunctions.free(o),m===1}catch(a){return console.error("WASM에 PCM 로드 에러:",a),!1}}togglePlayPause(){if(!this.audioPlayer)return;const i=document.getElementById("play-pause-btn");this.audioPlayer.isPlaying()?(this.audioPlayer.pause(),this.updateStatus("일시정지"),this.performanceMonitor.pause(),i.textContent="▶ 재생"):(this.audioPlayer.play(),this.updateStatus("재생 중..."),this.performanceMonitor.start(),i.textContent="⏸ 일시정지")}stop(){if(this.audioPlayer){this.audioPlayer.stop(),this.updateStatus("정지"),this.performanceMonitor.stop();const i=document.getElementById("play-pause-btn");i.textContent="▶ 재생"}}getWasmFrequencyData(){if(!this.wasmModule||!this.audioPlayer)return null;const i=this.audioPlayer.getCurrentTime(),a=this.wasmFunctions.getSampleRate(),c=Math.floor(i*a),o=this.audioPlayer.analyser?this.audioPlayer.analyser.fftSize:2048,d=o/2;this.currentFFTSize!==o&&(this.currentFFTSize=o,this.wasmFrequencyData=new Uint8Array(d),this.avgMagnitudesBuffer=new Float32Array(d));const m=4,y=Math.floor(o/4);if(this.wasmFunctions.getBatchFFTData){const v=this.wasmFunctions.getBatchFFTData(c,m,y,o);if(!v)return console.warn("배치 FFT 실패, 단일 FFT로 폴백"),this.getSingleWasmFFT(c,o,d);const g=v/4,P=this.wasmModule.HEAPF32;this.avgMagnitudesBuffer.fill(0);for(let l=0;l<m;l++){const _=g+l*d;for(let S=0;S<d;S++)this.avgMagnitudesBuffer[S]+=P[_+S]}let C=0;for(let l=0;l<d;l++)this.avgMagnitudesBuffer[l]/=m,this.avgMagnitudesBuffer[l]>C&&(C=this.avgMagnitudesBuffer[l]);const T=C>0?255/C:0;for(let l=0;l<d;l++)this.wasmFrequencyData[l]=Math.min(255,Math.floor(this.avgMagnitudesBuffer[l]*T));return this.wasmFrequencyData}else return console.warn("배치 FFT 사용 불가, 단일 FFT 사용"),this.getSingleWasmFFT(c,o,d)}getSingleWasmFFT(i,a,c){const o=this.wasmFunctions.getFFTDataAtOffset(i,a);if(!o)return this.audioPlayer.getFrequencyData();const d=o/4,m=this.wasmModule.HEAPF32;(!this.wasmFrequencyData||this.wasmFrequencyData.length!==c)&&(this.wasmFrequencyData=new Uint8Array(c));let y=0;for(let g=0;g<c;g++){const P=m[d+g];P>y&&(y=P)}const v=y>0?255/y:0;for(let g=0;g<c;g++){const P=m[d+g];this.wasmFrequencyData[g]=Math.min(255,Math.floor(P*v))}return this.wasmFrequencyData}updateStatus(i){document.getElementById("status").textContent=i}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new nt().init()}):new nt().init();
