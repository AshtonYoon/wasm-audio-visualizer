import{V as Ft,P as _t}from"./performance-monitor-C4boWBfy.js";function Et(f){return f&&f.__esModule&&Object.prototype.hasOwnProperty.call(f,"default")?f.default:f}function E(f){if(this.size=f|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=f<<1;for(var t=new Array(this.size*2),e=0;e<t.length;e+=2){const o=Math.PI*e/this.size;t[e]=Math.cos(o),t[e+1]=-Math.sin(o)}this.table=t;for(var r=0,n=1;this.size>n;n<<=1)r++;this._width=r%2===0?r-1:r,this._bitrev=new Array(1<<this._width);for(var i=0;i<this._bitrev.length;i++){this._bitrev[i]=0;for(var s=0;s<this._width;s+=2){var a=this._width-s-2;this._bitrev[i]|=(i>>>s&3)<<a}}this._out=null,this._data=null,this._inv=0}var wt=E;E.prototype.fromComplexArray=function(t,e){for(var r=e||new Array(t.length>>>1),n=0;n<t.length;n+=2)r[n>>>1]=t[n];return r};E.prototype.createComplexArray=function(){const t=new Array(this._csize);for(var e=0;e<t.length;e++)t[e]=0;return t};E.prototype.toComplexArray=function(t,e){for(var r=e||this.createComplexArray(),n=0;n<r.length;n+=2)r[n]=t[n>>>1],r[n+1]=0;return r};E.prototype.completeSpectrum=function(t){for(var e=this._csize,r=e>>>1,n=2;n<r;n+=2)t[e-n]=t[n],t[e-n+1]=-t[n+1]};E.prototype.transform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=0,this._transform4(),this._out=null,this._data=null};E.prototype.realTransform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=0,this._realTransform4(),this._out=null,this._data=null};E.prototype.inverseTransform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=1,this._transform4();for(var r=0;r<t.length;r++)t[r]/=this.size;this._out=null,this._data=null};E.prototype._transform4=function(){var t=this._out,e=this._csize,r=this._width,n=1<<r,i=e/n<<1,s,a,o=this._bitrev;if(i===4)for(s=0,a=0;s<e;s+=i,a++){const u=o[a];this._singleTransform2(s,u,n)}else for(s=0,a=0;s<e;s+=i,a++){const u=o[a];this._singleTransform4(s,u,n)}var l=this._inv?-1:1,c=this.table;for(n>>=2;n>=2;n>>=2){i=e/n<<1;var h=i>>>2;for(s=0;s<e;s+=i)for(var g=s+h,p=s,d=0;p<g;p+=2,d+=n){const u=p,v=u+h,m=v+h,y=m+h,w=t[u],b=t[u+1],z=t[v],F=t[v+1],_=t[m],T=t[m+1],S=t[y],I=t[y+1],A=w,C=b,D=c[d],U=l*c[d+1],R=z*D-F*U,M=z*U+F*D,L=c[2*d],W=l*c[2*d+1],x=_*L-T*W,q=_*W+T*L,N=c[3*d],k=l*c[3*d+1],J=S*N-I*k,H=S*k+I*N,G=A+x,P=C+q,B=A-x,K=C-q,Q=R+J,$=M+H,V=l*(R-J),X=l*(M-H),Y=G+Q,Z=P+$,j=G-Q,O=P-$,tt=B+X,et=K-V,nt=B-X,st=K+V;t[u]=Y,t[u+1]=Z,t[v]=tt,t[v+1]=et,t[m]=j,t[m+1]=O,t[y]=nt,t[y+1]=st}}};E.prototype._singleTransform2=function(t,e,r){const n=this._out,i=this._data,s=i[e],a=i[e+1],o=i[e+r],l=i[e+r+1],c=s+o,h=a+l,g=s-o,p=a-l;n[t]=c,n[t+1]=h,n[t+2]=g,n[t+3]=p};E.prototype._singleTransform4=function(t,e,r){const n=this._out,i=this._data,s=this._inv?-1:1,a=r*2,o=r*3,l=i[e],c=i[e+1],h=i[e+r],g=i[e+r+1],p=i[e+a],d=i[e+a+1],u=i[e+o],v=i[e+o+1],m=l+p,y=c+d,w=l-p,b=c-d,z=h+u,F=g+v,_=s*(h-u),T=s*(g-v),S=m+z,I=y+F,A=w+T,C=b-_,D=m-z,U=y-F,R=w-T,M=b+_;n[t]=S,n[t+1]=I,n[t+2]=A,n[t+3]=C,n[t+4]=D,n[t+5]=U,n[t+6]=R,n[t+7]=M};E.prototype._realTransform4=function(){var t=this._out,e=this._csize,r=this._width,n=1<<r,i=e/n<<1,s,a,o=this._bitrev;if(i===4)for(s=0,a=0;s<e;s+=i,a++){const it=o[a];this._singleRealTransform2(s,it>>>1,n>>>1)}else for(s=0,a=0;s<e;s+=i,a++){const it=o[a];this._singleRealTransform4(s,it>>>1,n>>>1)}var l=this._inv?-1:1,c=this.table;for(n>>=2;n>=2;n>>=2){i=e/n<<1;var h=i>>>1,g=h>>>1,p=g>>>1;for(s=0;s<e;s+=i)for(var d=0,u=0;d<=p;d+=2,u+=n){var v=s+d,m=v+g,y=m+g,w=y+g,b=t[v],z=t[v+1],F=t[m],_=t[m+1],T=t[y],S=t[y+1],I=t[w],A=t[w+1],C=b,D=z,U=c[u],R=l*c[u+1],M=F*U-_*R,L=F*R+_*U,W=c[2*u],x=l*c[2*u+1],q=T*W-S*x,N=T*x+S*W,k=c[3*u],J=l*c[3*u+1],H=I*k-A*J,G=I*J+A*k,P=C+q,B=D+N,K=C-q,Q=D-N,$=M+H,V=L+G,X=l*(M-H),Y=l*(L-G),Z=P+$,j=B+V,O=K+Y,tt=Q-X;if(t[v]=Z,t[v+1]=j,t[m]=O,t[m+1]=tt,d===0){var et=P-$,nt=B-V;t[y]=et,t[y+1]=nt;continue}if(d!==p){var st=K,lt=-Q,ct=P,ht=-B,ut=-l*Y,dt=-l*X,ft=-l*V,vt=-l*$,mt=st+ut,gt=lt+dt,pt=ct+vt,yt=ht-ft,rt=s+g-d,at=s+h-d;t[rt]=mt,t[rt+1]=gt,t[at]=pt,t[at+1]=yt}}}};E.prototype._singleRealTransform2=function(t,e,r){const n=this._out,i=this._data,s=i[e],a=i[e+r],o=s+a,l=s-a;n[t]=o,n[t+1]=0,n[t+2]=l,n[t+3]=0};E.prototype._singleRealTransform4=function(t,e,r){const n=this._out,i=this._data,s=this._inv?-1:1,a=r*2,o=r*3,l=i[e],c=i[e+r],h=i[e+a],g=i[e+o],p=l+h,d=l-h,u=c+g,v=s*(c-g),m=p+u,y=d,w=-v,b=p-u,z=d,F=v;n[t]=m,n[t+1]=0,n[t+2]=y,n[t+3]=w,n[t+4]=b,n[t+5]=0,n[t+6]=z,n[t+7]=F};const zt=Et(wt);class ot{constructor(){this.audioData=null,this.sampleRate=44100,this.channels=2,this.duration=0,this.audioElement=null,this.isPlaying=!1,this.visualizer=null,this.performanceMonitor=null,this.fftSize=2048,this.fft=null,this.fftInput=null,this.fftOutput=null,this.frequencyData=null}async init(){try{console.log("Starting initialization..."),document.getElementById("loading").classList.add("active"),this.updateStatus("Initializing Pure JavaScript FFT visualizer..."),console.log("Creating audio element..."),this.audioElement=new Audio,this.audioElement.addEventListener("play",()=>{this.isPlaying=!0}),this.audioElement.addEventListener("pause",()=>{this.isPlaying=!1}),this.audioElement.addEventListener("ended",()=>{this.isPlaying=!1}),console.log("Audio element created:",this.audioElement),console.log("Creating Visualizer3D..."),this.visualizer=new Ft("canvas-container"),console.log("Visualizer3D created:",this.visualizer),console.log("Creating PerformanceMonitor...");try{this.performanceMonitor=new _t,this.performanceMonitor.start(),console.log("PerformanceMonitor created and started:",this.performanceMonitor)}catch(t){console.error("PerformanceMonitor creation failed:",t),this.performanceMonitor={beginFrame:()=>{},endFrame:()=>{},beginFFT:()=>{},endFFT:()=>{}}}console.log("Initializing FFT with size:",this.fftSize),this.initFFT(this.fftSize),console.log("FFT initialized:",this.fft),console.log("Setting up event listeners..."),this.setupEventListeners(),document.getElementById("loading").classList.remove("active"),this.updateStatus("Ready. Load an audio file to begin."),console.log("Pure JavaScript FFT visualizer initialized successfully")}catch(t){console.error("Failed to initialize app:",t),console.error("Error stack:",t.stack),this.updateStatus("Error: Failed to initialize visualizer. Check console for details.")}}initFFT(t){this.fftSize=t,this.fft=new zt(t),this.fftInput=new Array(t),this.fftOutput=this.fft.createComplexArray(),this.frequencyData=new Uint8Array(t/2),console.log(`FFT initialized with size ${t}`)}setFFTSize(t){this.initFFT(t),console.log(`FFT size changed to ${t}`)}setupEventListeners(){document.getElementById("audio-file").addEventListener("change",s=>this.handleFileSelect(s)),document.getElementById("play-btn").addEventListener("click",()=>this.play()),document.getElementById("pause-btn").addEventListener("click",()=>this.pause()),document.getElementById("stop-btn").addEventListener("click",()=>this.stop()),document.getElementById("fft-size").addEventListener("change",s=>{const a=parseInt(s.target.value);this.setFFTSize(a)}),document.getElementById("color-scheme").addEventListener("change",s=>{const a=s.target.value;this.visualizer&&this.visualizer.setColorScheme(a)});const n=document.getElementById("sensitivity"),i=document.getElementById("sensitivity-value");n.addEventListener("input",s=>{const a=parseFloat(s.target.value);i.textContent=a.toFixed(1),this.visualizer&&this.visualizer.setSensitivity(a)}),this.animate()}async handleFileSelect(t){const e=t.target.files[0];if(e)try{this.updateStatus(`Loading ${e.name}...`),console.log(`Loading file: ${e.name}, type: ${e.type}, size: ${e.size} bytes`);const r=performance.now(),n=await e.arrayBuffer();console.log(`ArrayBuffer loaded, size: ${n.byteLength} bytes`),this.updateStatus(`Parsing ${e.name}...`),console.log("Parsing WAV file...");try{const a=this.parseWAV(n);this.audioData=a.audioData,this.sampleRate=a.sampleRate,this.channels=a.channels,this.duration=a.duration}catch(a){throw console.error("WAV parsing error:",a),new Error(`Failed to parse ${e.name}. Only WAV format is supported.`)}const i=performance.now()-r;console.log(`âœ“ Parsed: ${e.name}, ${this.duration.toFixed(2)}s, ${this.sampleRate}Hz, ${this.channels}ch`),console.log(`Load time: ${i.toFixed(2)}ms`);const s=URL.createObjectURL(e);this.audioElement.src=s,this.audioElement.load(),document.getElementById("play-btn").disabled=!1,document.getElementById("pause-btn").disabled=!1,document.getElementById("stop-btn").disabled=!1,this.updateStatus(`Ready to play: ${e.name}`)}catch(r){console.error("Failed to load audio file:",r),this.updateStatus(`Error: ${r.message}`)}}parseWAV(t){const e=new DataView(t);if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="RIFF")throw new Error("Not a valid WAV file (missing RIFF header)");if(String.fromCharCode(e.getUint8(8),e.getUint8(9),e.getUint8(10),e.getUint8(11))!=="WAVE")throw new Error("Not a valid WAV file (missing WAVE format)");let i=12;for(;i<e.byteLength;){const s=String.fromCharCode(e.getUint8(i),e.getUint8(i+1),e.getUint8(i+2),e.getUint8(i+3)),a=e.getUint32(i+4,!0);if(s==="fmt "){const o=e.getUint16(i+10,!0),l=e.getUint32(i+12,!0),c=e.getUint16(i+22,!0);console.log(`WAV format: ${o}ch, ${l}Hz, ${c}bit`);let h=i+8+a;for(;h<e.byteLength;){const g=String.fromCharCode(e.getUint8(h),e.getUint8(h+1),e.getUint8(h+2),e.getUint8(h+3)),p=e.getUint32(h+4,!0);if(g==="data"){const d=p/(c/8)/o,u=new Float32Array(d);let v=0;const m=c/8,y=h+8;for(let w=0;w<d;w++){let b=0;for(let z=0;z<o;z++){const F=y+(w*o+z)*m;let _=0;if(c===16)_=e.getInt16(F,!0)/32768;else if(c===8)_=(e.getUint8(F)-128)/128;else if(c===24){const T=e.getUint8(F),S=e.getUint8(F+1);_=(e.getInt8(F+2)<<16|S<<8|T)/8388608}else c===32&&(_=e.getFloat32(F,!0));b+=_}u[v++]=b/o}return{audioData:u,sampleRate:l,channels:o,duration:d/l}}h+=8+p}throw new Error("No data chunk found in WAV file")}i+=8+a}throw new Error("No fmt chunk found in WAV file")}play(){!this.audioData||!this.audioElement||(this.audioElement.play(),console.log("Playback started"))}pause(){this.audioElement&&(this.audioElement.pause(),console.log("Playback paused"))}stop(){this.audioElement&&(this.audioElement.pause(),this.audioElement.currentTime=0,console.log("Playback stopped"))}getCurrentTime(){return this.audioElement?this.audioElement.currentTime:0}animate(){if(requestAnimationFrame(()=>this.animate()),this.performanceMonitor.beginFrame(),this.isPlaying&&this.audioData){this.performanceMonitor.beginFFT();const t=this.getFrequencyData();this.performanceMonitor.endFFT(),t&&this.visualizer&&this.visualizer.updateFrequency(t)}this.visualizer&&this.visualizer.render(),this.performanceMonitor.endFrame()}getFrequencyData(){if(!this.audioData||!this.isPlaying)return null;const t=this.getCurrentTime(),e=Math.floor(t*this.sampleRate),r=this.audioData,n=this.fftSize;if(e+n>r.length)return null;for(let o=0;o<n;o++){const l=.5*(1-Math.cos(2*Math.PI*o/(n-1)));this.fftInput[o]=r[e+o]*l}this.fft.realTransform(this.fftOutput,this.fftInput);const i=this.fftSize/2;let s=0;for(let o=0;o<i;o++){const l=this.fftOutput[o*2],c=this.fftOutput[o*2+1],h=Math.sqrt(l*l+c*c);h>s&&(s=h),this.frequencyData[o]=h}const a=s>0?255/s:0;for(let o=0;o<i;o++)this.frequencyData[o]=Math.min(255,Math.floor(this.frequencyData[o]*a));return this.frequencyData}updateStatus(t){document.getElementById("status").textContent=t}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new ot().init()}):new ot().init();
