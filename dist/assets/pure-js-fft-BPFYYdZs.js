import{V as b,P as A}from"./performance-monitor-Dvt__9VL.js";class B{constructor(t){if(this.size=t,!this.isPowerOfTwo(t))throw new Error(`FFT size must be a power of 2, got ${t}`);this.reversedBits=new Uint32Array(t),this.computeReversedBits(),this.twiddleCos=new Float32Array(t/2),this.twiddleSin=new Float32Array(t/2),this.computeTwiddleFactors()}isPowerOfTwo(t){return t>0&&(t&t-1)===0}computeReversedBits(){const t=this.size,e=Math.log2(t);for(let o=0;o<t;o++){let s=0,n=o;for(let r=0;r<e;r++)s=s<<1|n&1,n>>=1;this.reversedBits[o]=s}}computeTwiddleFactors(){const t=this.size;for(let e=0;e<t/2;e++){const o=-2*Math.PI*e/t;this.twiddleCos[e]=Math.cos(o),this.twiddleSin[e]=Math.sin(o)}}createComplexArray(){return new Float32Array(this.size*2)}realTransform(t,e){const o=this.size;for(let s=0;s<o;s++){const n=this.reversedBits[s];t[2*n]=e[s],t[2*n+1]=0}for(let s=2;s<=o;s*=2){const n=s/2,r=o/s;for(let a=0;a<o;a+=s)for(let i=0;i<n;i++){const c=a+i,l=a+i+n,h=i*r,g=this.twiddleCos[h],u=this.twiddleSin[h],d=t[2*l],m=t[2*l+1],y=g*d-u*m,p=g*m+u*d,F=t[2*c],f=t[2*c+1];t[2*c]=F+y,t[2*c+1]=f+p,t[2*l]=F-y,t[2*l+1]=f-p}}}inverseTransform(t,e){const o=this.size,s=new Float32Array(o*2);for(let n=0;n<o;n++)s[2*n]=e[2*n],s[2*n+1]=-e[2*n+1];this.complexTransform(t,s);for(let n=0;n<o;n++)t[2*n]=t[2*n]/o,t[2*n+1]=-t[2*n+1]/o}complexTransform(t,e){const o=this.size;for(let s=0;s<o;s++){const n=this.reversedBits[s];t[2*n]=e[2*s],t[2*n+1]=e[2*s+1]}for(let s=2;s<=o;s*=2){const n=s/2,r=o/s;for(let a=0;a<o;a+=s)for(let i=0;i<n;i++){const c=a+i,l=a+i+n,h=i*r,g=this.twiddleCos[h],u=this.twiddleSin[h],d=t[2*l],m=t[2*l+1],y=g*d-u*m,p=g*m+u*d,F=t[2*c],f=t[2*c+1];t[2*c]=F+y,t[2*c+1]=f+p,t[2*l]=F-y,t[2*l+1]=f-p}}}}class T{constructor(){this.audioData=null,this.sampleRate=44100,this.channels=2,this.duration=0,this.audioElement=null,this.isPlaying=!1,this.visualizer=null,this.performanceMonitor=null,this.fftSize=2048,this.fft=null,this.fftInput=null,this.fftOutput=null,this.frequencyData=null}async init(){try{console.log("초기화 시작..."),document.getElementById("loading").classList.add("active"),this.updateStatus("순수 JavaScript DFT 비주얼라이저 초기화 중..."),console.log("오디오 엘리먼트 생성 중..."),this.audioElement=new Audio,this.audioElement.addEventListener("play",()=>{this.isPlaying=!0}),this.audioElement.addEventListener("pause",()=>{this.isPlaying=!1}),this.audioElement.addEventListener("ended",()=>{this.isPlaying=!1}),console.log("오디오 엘리먼트 생성 완료:",this.audioElement),console.log("Visualizer3D 생성 중..."),this.visualizer=new b("canvas-container"),console.log("Visualizer3D 생성 완료:",this.visualizer),console.log("PerformanceMonitor 생성 중...");try{this.performanceMonitor=new A,this.performanceMonitor.start(),console.log("PerformanceMonitor 생성 및 시작 완료:",this.performanceMonitor)}catch(t){console.error("PerformanceMonitor 생성 실패:",t),this.performanceMonitor={beginFrame:()=>{},endFrame:()=>{},beginFFT:()=>{},endFFT:()=>{}}}console.log("FFT 초기화 중, 크기:",this.fftSize),this.initFFT(this.fftSize),console.log("FFT 초기화 완료:",this.fft),console.log("이벤트 리스너 설정 중..."),this.setupEventListeners(),document.getElementById("loading").classList.remove("active"),this.updateStatus("준비 완료. 오디오 파일을 로드하세요."),console.log("순수 JavaScript FFT 비주얼라이저 초기화 완료")}catch(t){console.error("앱 초기화 실패:",t),console.error("에러 스택:",t.stack),this.updateStatus("에러: 비주얼라이저 초기화 실패. 콘솔을 확인하세요.")}}initFFT(t){this.fftSize=t,this.fft=new B(t),this.fftInput=new Float32Array(t),this.fftOutput=this.fft.createComplexArray(),this.frequencyData=new Uint8Array(t/2),console.log(`순수 JavaScript FFT 초기화 완료, 크기: ${t}`)}setFFTSize(t){this.initFFT(t),console.log(`FFT 크기 변경: ${t}`)}setupEventListeners(){document.getElementById("audio-file").addEventListener("change",r=>this.handleFileSelect(r)),document.getElementById("play-pause-btn").addEventListener("click",()=>this.togglePlayPause()),document.getElementById("stop-btn").addEventListener("click",()=>this.stop()),document.getElementById("fft-size").addEventListener("change",r=>{const a=parseInt(r.target.value);this.setFFTSize(a)}),document.getElementById("color-scheme").addEventListener("change",r=>{const a=r.target.value;this.visualizer&&this.visualizer.setColorScheme(a)});const s=document.getElementById("sensitivity"),n=document.getElementById("sensitivity-value");s.addEventListener("input",r=>{const a=parseFloat(r.target.value);n.textContent=a.toFixed(1),this.visualizer&&this.visualizer.setSensitivity(a)}),this.animate()}async handleFileSelect(t){const e=t.target.files[0];if(e)try{this.updateStatus(`${e.name} 로딩 중...`),console.log(`파일 로드 중: ${e.name}, 타입: ${e.type}, 크기: ${e.size} bytes`);const o=performance.now(),s=await e.arrayBuffer();console.log(`ArrayBuffer 로드 완료, 크기: ${s.byteLength} bytes`),this.updateStatus(`${e.name} 파싱 중...`),console.log("WAV 파일 파싱 중...");try{const a=this.parseWAV(s);this.audioData=a.audioData,this.sampleRate=a.sampleRate,this.channels=a.channels,this.duration=a.duration}catch(a){throw console.error("WAV 파싱 에러:",a),new Error(`${e.name} 파싱 실패. WAV 포맷만 지원됩니다.`)}const n=performance.now()-o;console.log(`✓ 파싱 완료: ${e.name}, ${this.duration.toFixed(2)}초, ${this.sampleRate}Hz, ${this.channels}채널`),console.log(`로드 시간: ${n.toFixed(2)}ms`);const r=URL.createObjectURL(e);this.audioElement.src=r,this.audioElement.load(),document.getElementById("play-pause-btn").disabled=!1,document.getElementById("stop-btn").disabled=!1,this.updateStatus(`재생 준비 완료: ${e.name}`)}catch(o){console.error("오디오 파일 로드 실패:",o),this.updateStatus(`에러: ${o.message}`)}}parseWAV(t){const e=new DataView(t);if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="RIFF")throw new Error("유효한 WAV 파일이 아닙니다 (RIFF 헤더 누락)");if(String.fromCharCode(e.getUint8(8),e.getUint8(9),e.getUint8(10),e.getUint8(11))!=="WAVE")throw new Error("유효한 WAV 파일이 아닙니다 (WAVE 포맷 누락)");let n=12;for(;n<e.byteLength;){const r=String.fromCharCode(e.getUint8(n),e.getUint8(n+1),e.getUint8(n+2),e.getUint8(n+3)),a=e.getUint32(n+4,!0);if(r==="fmt "){const i=e.getUint16(n+10,!0),c=e.getUint32(n+12,!0),l=e.getUint16(n+22,!0);console.log(`WAV 포맷: ${i}채널, ${c}Hz, ${l}bit`);let h=n+8+a;for(;h<e.byteLength;){const g=String.fromCharCode(e.getUint8(h),e.getUint8(h+1),e.getUint8(h+2),e.getUint8(h+3)),u=e.getUint32(h+4,!0);if(g==="data"){const d=u/(l/8)/i,m=new Float32Array(d);let y=0;const p=l/8,F=h+8;for(let f=0;f<d;f++){let I=0;for(let S=0;S<i;S++){const w=F+(f*i+S)*p;let v=0;if(l===16)v=e.getInt16(w,!0)/32768;else if(l===8)v=(e.getUint8(w)-128)/128;else if(l===24){const z=e.getUint8(w),U=e.getUint8(w+1);v=(e.getInt8(w+2)<<16|U<<8|z)/8388608}else l===32&&(v=e.getFloat32(w,!0));I+=v}m[y++]=I/i}return{audioData:m,sampleRate:c,channels:i,duration:d/c}}h+=8+u}throw new Error("WAV 파일에서 data 청크를 찾을 수 없습니다")}n+=8+a}throw new Error("WAV 파일에서 fmt 청크를 찾을 수 없습니다")}togglePlayPause(){if(!this.audioData||!this.audioElement)return;const t=document.getElementById("play-pause-btn");this.isPlaying?(this.audioElement.pause(),t.textContent="▶ 재생",console.log("재생 일시정지")):(this.audioElement.play(),t.textContent="⏸ 일시정지",console.log("재생 시작"))}stop(){if(!this.audioElement)return;this.audioElement.pause(),this.audioElement.currentTime=0;const t=document.getElementById("play-pause-btn");t.textContent="▶ 재생",console.log("재생 정지")}getCurrentTime(){return this.audioElement?this.audioElement.currentTime:0}animate(){if(requestAnimationFrame(()=>this.animate()),this.performanceMonitor.beginFrame(),this.isPlaying&&this.audioData){this.performanceMonitor.beginFFT();const t=this.getFrequencyData();this.performanceMonitor.endFFT(),t&&this.visualizer&&this.visualizer.updateFrequency(t)}this.visualizer&&this.visualizer.render(),this.performanceMonitor.endFrame()}getFrequencyData(){if(!this.audioData||!this.isPlaying)return null;const t=this.getCurrentTime(),e=Math.floor(t*this.sampleRate),o=this.audioData,s=this.fftSize;if(e+s>o.length)return null;for(let i=0;i<s;i++){const c=.5*(1-Math.cos(2*Math.PI*i/(s-1)));this.fftInput[i]=o[e+i]*c}this.fft.realTransform(this.fftOutput,this.fftInput);const n=this.fftSize/2;let r=0;for(let i=0;i<n;i++){const c=this.fftOutput[i*2],l=this.fftOutput[i*2+1],h=Math.sqrt(c*c+l*l);h>r&&(r=h),this.frequencyData[i]=h}const a=r>0?255/r:0;for(let i=0;i<n;i++)this.frequencyData[i]=Math.min(255,Math.floor(this.frequencyData[i]*a));return this.frequencyData}updateStatus(t){document.getElementById("status").textContent=t}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new T().init()}):new T().init();
