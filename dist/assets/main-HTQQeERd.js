var Lt=Object.defineProperty;var Vt=(w,i,a)=>i in w?Lt(w,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):w[i]=a;var at=(w,i,a)=>Vt(w,typeof i!="symbol"?i+"":i,a);import{V as xt,P as Ot}from"./performance-monitor-Dvt__9VL.js";async function Nt(w={}){var i,a=w,y=import.meta.url,f="";function c(t){return a.locateFile?a.locateFile(t,f):f+t}var d;{try{f=new URL(".",y).href}catch{}d=async t=>{var e=await fetch(t,{credentials:"same-origin"});if(e.ok)return e.arrayBuffer();throw new Error(e.status+" : "+e.url)}}var A=console.log.bind(console),m=console.error.bind(console),h,g=!1,p,S,P,b,z,k,F,$,U,I,H=!1;function L(){var t=E.buffer;a.HEAP8=P=new Int8Array(t),z=new Int16Array(t),a.HEAPU8=b=new Uint8Array(t),k=new Int32Array(t),F=new Uint32Array(t),a.HEAPF32=$=new Float32Array(t),U=new Float64Array(t),I=new BigInt64Array(t),new BigUint64Array(t)}function it(){if(a.preRun)for(typeof a.preRun=="function"&&(a.preRun=[a.preRun]);a.preRun.length;)yt(a.preRun.shift());V(O)}function rt(){H=!0,T.g()}function st(){if(a.postRun)for(typeof a.postRun=="function"&&(a.postRun=[a.postRun]);a.postRun.length;)mt(a.postRun.shift());V(x)}function M(t){var n;(n=a.onAbort)==null||n.call(a,t),t="Aborted("+t+")",m(t),g=!0,t+=". Build with -sASSERTIONS for more info.";var e=new WebAssembly.RuntimeError(t);throw S==null||S(e),e}var W;function ot(){return a.locateFile?c("audio-visualizer.wasm"):new URL("/audio-visualizer.wasm",import.meta.url).href}function ut(t){if(t==W&&h)return new Uint8Array(h);throw"both async and sync fetching of the wasm failed"}async function lt(t){if(!h)try{var e=await d(t);return new Uint8Array(e)}catch{}return ut(t)}async function ct(t,e){try{var n=await lt(t),r=await WebAssembly.instantiate(n,e);return r}catch(u){m(`failed to asynchronously prepare wasm: ${u}`),M(u)}}async function ft(t,e,n){if(!t)try{var r=fetch(e,{credentials:"same-origin"}),u=await WebAssembly.instantiateStreaming(r,n);return u}catch(o){m(`wasm streaming compile failed: ${o}`),m("falling back to ArrayBuffer instantiation")}return ct(e,n)}function ht(){var t={a:Wt};return t}async function dt(){function t(o,s){return T=o.exports,It(T),L(),T}function e(o){return t(o.instance)}var n=ht();if(a.instantiateWasm)return new Promise((o,s)=>{a.instantiateWasm(n,(l,_)=>{o(t(l))})});W??(W=ot());var r=await ft(h,W,n),u=e(r);return u}var V=t=>{for(;t.length>0;)t.shift()(a)},x=[],mt=t=>x.push(t),O=[],yt=t=>O.push(t);function gt(t,e="i8"){switch(e.endsWith("*")&&(e="*"),e){case"i1":return P[t];case"i8":return P[t];case"i16":return z[t>>1];case"i32":return k[t>>2];case"i64":return I[t>>3];case"float":return $[t>>2];case"double":return U[t>>3];case"*":return F[t>>2];default:M(`invalid type for getValue: ${e}`)}}function pt(t,e,n="i8"){switch(n.endsWith("*")&&(n="*"),n){case"i1":P[t]=e;break;case"i8":P[t]=e;break;case"i16":z[t>>1]=e;break;case"i32":k[t>>2]=e;break;case"i64":I[t>>3]=BigInt(e);break;case"float":$[t>>2]=e;break;case"double":U[t>>3]=e;break;case"*":F[t>>2]=e;break;default:M(`invalid type for setValue: ${n}`)}}var vt=t=>Z(t),wt=()=>tt(),N=globalThis.TextDecoder&&new TextDecoder,Ft=(t,e,n,r)=>{for(var u=e+n;t[e]&&!(e>=u);)++e;return e},j=(t,e=0,n,r)=>{var u=Ft(t,e,n);if(u-e>16&&t.buffer&&N)return N.decode(t.subarray(e,u));for(var o="";e<u;){var s=t[e++];if(!(s&128)){o+=String.fromCharCode(s);continue}var l=t[e++]&63;if((s&224)==192){o+=String.fromCharCode((s&31)<<6|l);continue}var _=t[e++]&63;if((s&240)==224?s=(s&15)<<12|l<<6|_:s=(s&7)<<18|l<<12|_<<6|t[e++]&63,s<65536)o+=String.fromCharCode(s);else{var C=s-65536;o+=String.fromCharCode(55296|C>>10,56320|C&1023)}}return o},D=(t,e,n)=>t?j(b,t,e):"",At=(t,e,n,r)=>M(`Assertion failed: ${D(t)}, at: `+[e?D(e):"unknown filename",n,r?D(r):"unknown function"]);class _t{constructor(e){this.excPtr=e,this.ptr=e-24}set_type(e){F[this.ptr+4>>2]=e}get_type(){return F[this.ptr+4>>2]}set_destructor(e){F[this.ptr+8>>2]=e}get_destructor(){return F[this.ptr+8>>2]}set_caught(e){e=e?1:0,P[this.ptr+12]=e}get_caught(){return P[this.ptr+12]!=0}set_rethrown(e){e=e?1:0,P[this.ptr+13]=e}get_rethrown(){return P[this.ptr+13]!=0}init(e,n){this.set_adjusted_ptr(0),this.set_type(e),this.set_destructor(n)}set_adjusted_ptr(e){F[this.ptr+16>>2]=e}get_adjusted_ptr(){return F[this.ptr+16>>2]}}var J=0,Pt=(t,e,n)=>{var r=new _t(t);throw r.init(e,n),J=t,J},St=()=>M(""),Ct=()=>536870912,Bt=(t,e)=>Math.ceil(t/e)*e,bt=t=>{var e=E.buffer.byteLength,n=(t-e+65535)/65536|0;try{return E.grow(n),L(),1}catch{}},Mt=t=>{var e=b.length;t>>>=0;var n=Ct();if(t>n)return!1;for(var r=1;r<=4;r*=2){var u=e*(1+.2/r);u=Math.min(u,t+100663296);var o=Math.min(n,Bt(Math.max(t,u),65536)),s=bt(o);if(s)return!0}return!1},Tt=[null,[],[]],Rt=(t,e)=>{var n=Tt[t];e===0||e===10?((t===1?A:m)(j(n)),n.length=0):n.push(e)},Dt=(t,e,n,r)=>{for(var u=0,o=0;o<n;o++){var s=F[e>>2],l=F[e+4>>2];e+=8;for(var _=0;_<l;_++)Rt(t,b[s+_]);u+=l}return F[r>>2]=u,0},K=t=>{var e=a["_"+t];return e},Q=(t,e)=>{P.set(t,e)},Et=t=>{for(var e=0,n=0;n<t.length;++n){var r=t.charCodeAt(n);r<=127?e++:r<=2047?e+=2:r>=55296&&r<=57343?(e+=4,++n):e+=3}return e},zt=(t,e,n,r)=>{if(!(r>0))return 0;for(var u=n,o=n+r-1,s=0;s<t.length;++s){var l=t.codePointAt(s);if(l<=127){if(n>=o)break;e[n++]=l}else if(l<=2047){if(n+1>=o)break;e[n++]=192|l>>6,e[n++]=128|l&63}else if(l<=65535){if(n+2>=o)break;e[n++]=224|l>>12,e[n++]=128|l>>6&63,e[n++]=128|l&63}else{if(n+3>=o)break;e[n++]=240|l>>18,e[n++]=128|l>>12&63,e[n++]=128|l>>6&63,e[n++]=128|l&63,s++}}return e[n]=0,n-u},kt=(t,e,n)=>zt(t,b,e,n),X=t=>G(t),$t=t=>{var e=Et(t)+1,n=X(e);return kt(t,n,e),n},Y=(t,e,n,r,u)=>{var o={string:v=>{var R=0;return v!=null&&v!==0&&(R=$t(v)),R},array:v=>{var R=X(v.length);return Q(v,R),R}};function s(v){return e==="string"?D(v):e==="boolean"?!!v:v}var l=K(t),_=[],C=0;if(r)for(var B=0;B<r.length;B++){var et=o[n[B]];et?(C===0&&(C=wt()),_[B]=et(r[B])):_[B]=r[B]}var q=l(..._);function Ht(v){return C!==0&&vt(C),s(v)}return q=Ht(q),q},Ut=(t,e,n,r)=>{var u=!n||n.every(s=>s==="number"||s==="boolean"),o=e!=="string";return o&&u&&!r?K(t):(...s)=>Y(t,e,n,s)};if(a.noExitRuntime&&a.noExitRuntime,a.print&&(A=a.print),a.printErr&&(m=a.printErr),a.wasmBinary&&(h=a.wasmBinary),a.arguments&&a.arguments,a.thisProgram&&a.thisProgram,a.preInit)for(typeof a.preInit=="function"&&(a.preInit=[a.preInit]);a.preInit.length>0;)a.preInit.shift()();a.ccall=Y,a.cwrap=Ut,a.setValue=pt,a.getValue=gt,a.writeArrayToMemory=Q;var Z,G,tt,E;function It(t){a._loadAudio=t.h,a._loadPCMData=t.i,a._getFFTData=t.j,a._getFFTDataAtOffset=t.k,a._getSampleCount=t.l,a._getSampleRate=t.m,a._getChannels=t.n,a._cleanup=t.o,a._malloc=t.p,a._free=t.q,Z=t.r,G=t.s,tt=t.t,E=t.f,t.__indirect_function_table}var Wt={a:At,c:Pt,d:St,e:Mt,b:Dt};function qt(){it();function t(){var e;a.calledRun=!0,!g&&(rt(),p==null||p(a),(e=a.onRuntimeInitialized)==null||e.call(a),st())}a.setStatus?(a.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>a.setStatus(""),1),t()},1)):t()}var T;return T=await dt(),qt(),H?i=a:i=new Promise((t,e)=>{p=t,S=e}),i}class jt{constructor(){this.audioContext=null,this.source=null,this.analyser=null,this.audioBuffer=null,this.startTime=0,this.pauseTime=0,this._isPlaying=!1,this.frequencyData=null}async loadFile(i){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.audioBuffer=await this.audioContext.decodeAudioData(i),this.analyser||(this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.connect(this.audioContext.destination),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)),console.log(`Audio decoded: ${this.audioBuffer.duration.toFixed(2)}s`)}async loadFromAudioBuffer(i){this.audioBuffer=i,this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.analyser||(this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.analyser.connect(this.audioContext.destination),this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)),console.log(`Audio loaded: ${i.duration.toFixed(2)}s, ${i.sampleRate}Hz, ${i.numberOfChannels}ch`)}play(){if(!this.audioBuffer)return;this.source&&this.source.stop(),this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.analyser);const i=this.pauseTime;this.source.start(0,i),this.startTime=this.audioContext.currentTime-i,this._isPlaying=!0,this.source.onended=()=>{this._isPlaying&&(this._isPlaying=!1,this.pauseTime=0)}}pause(){!this.source||!this._isPlaying||(this.pauseTime=this.audioContext.currentTime-this.startTime,this.source.stop(),this._isPlaying=!1)}stop(){this.source&&(this.source.stop(),this.pauseTime=0,this._isPlaying=!1)}getFrequencyData(){return this.analyser?(this.analyser.getByteFrequencyData(this.frequencyData),this.frequencyData):null}isPlaying(){return this._isPlaying}getCurrentTime(){return this._isPlaying?this.audioContext.currentTime-this.startTime:this.pauseTime}}class Jt{constructor(i){this.app=i,this.init()}init(){document.getElementById("fft-size").addEventListener("change",c=>{const d=parseInt(c.target.value);this.app.audioPlayer&&this.app.audioPlayer.analyser&&(this.app.audioPlayer.analyser.fftSize=d,this.app.audioPlayer.frequencyData=new Uint8Array(this.app.audioPlayer.analyser.frequencyBinCount),console.log(`FFT size changed to: ${d}`))}),document.getElementById("color-scheme").addEventListener("change",c=>{const d=c.target.value;this.app.visualizer&&this.app.visualizer.setColorScheme(d)});const y=document.getElementById("sensitivity"),f=document.getElementById("sensitivity-value");y.addEventListener("input",c=>{const d=parseFloat(c.target.value);f.textContent=d.toFixed(1),this.app.visualizer&&this.app.visualizer.setSensitivity(d)})}}class nt{constructor(){at(this,"animate",()=>{if(requestAnimationFrame(this.animate),this.performanceMonitor.beginFrame(),this.visualizer&&this.visualizer.render(),this.audioPlayer&&this.audioPlayer.isPlaying()){this.performanceMonitor.beginFFT();const i=this.getWasmFrequencyData();this.performanceMonitor.endFFT(),i&&this.visualizer&&this.visualizer.updateFrequency(i)}this.performanceMonitor.endFrame()});this.wasmModule=null,this.audioPlayer=null,this.visualizer=null,this.uiControls=null,this.performanceMonitor=null,this.audioData=null,this.wasmFrequencyData=null,this.avgMagnitudesBuffer=null,this.currentFFTSize=0,this.wasmFunctions={getSampleCount:null,getSampleRate:null,getChannels:null,getSamples:null,loadAudio:null,getBatchFFTData:null,getFFTDataAtOffset:null,malloc:null,free:null}}async init(){try{document.getElementById("loading").classList.add("active"),this.updateStatus("WASM 모듈 로딩 중..."),this.wasmModule=await Nt(),console.log("WASM 모듈 로드 완료"),this.cacheWasmFunctions(),this.audioPlayer=new jt,this.visualizer=new xt("canvas-container"),this.uiControls=new Jt(this),this.performanceMonitor=new Ot,this.setupEventListeners(),document.getElementById("loading").classList.remove("active"),this.updateStatus("준비 완료. 오디오 파일을 로드하세요.")}catch(i){console.error("앱 초기화 실패:",i),this.updateStatus("에러: WASM 모듈 로드 실패. 콘솔을 확인하세요.")}}cacheWasmFunctions(){this.wasmFunctions.getSampleCount=this.wasmModule._getSampleCount,this.wasmFunctions.getSampleRate=this.wasmModule._getSampleRate,this.wasmFunctions.getChannels=this.wasmModule._getChannels,this.wasmFunctions.getSamples=this.wasmModule._getSamples,this.wasmFunctions.loadAudio=this.wasmModule._loadAudio,this.wasmFunctions.getBatchFFTData=this.wasmModule._getBatchFFTData,this.wasmFunctions.getFFTDataAtOffset=this.wasmModule._getFFTDataAtOffset,this.wasmFunctions.malloc=this.wasmModule._malloc,this.wasmFunctions.free=this.wasmModule._free}setupEventListeners(){document.getElementById("audio-file").addEventListener("change",a=>this.handleFileSelect(a)),document.getElementById("play-pause-btn").addEventListener("click",()=>this.togglePlayPause()),document.getElementById("stop-btn").addEventListener("click",()=>this.stop()),this.animate()}async handleFileSelect(i){const a=i.target.files[0];if(a)try{this.updateStatus(`${a.name} 로딩 중...`),console.log(`파일 로드 중: ${a.name}, 타입: ${a.type}, 크기: ${a.size} bytes`);const y=await a.arrayBuffer();console.log(`ArrayBuffer 로드 완료, 크기: ${y.byteLength} bytes`),this.updateStatus(`${a.name} 디코딩 중...`),console.log("WASM audio_decoder로 디코딩 중...");const f=new Uint8Array(y),c=this.wasmFunctions.malloc(f.length);new Uint8Array(this.wasmModule.HEAPU8.buffer,c,f.length).set(f);const A=this.wasmFunctions.loadAudio(c,f.length);if(this.wasmFunctions.free(c),!A)throw new Error(`${a.name} 디코딩 실패. WAV 파일만 지원됩니다.`);const m=this.wasmFunctions.getSampleCount(),h=this.wasmFunctions.getSampleRate(),g=this.wasmFunctions.getChannels();console.log(`✓ 디코딩 완료: ${a.name}, ${m} 샘플, ${h}Hz, ${g}채널`),this.updateStatus("AudioBuffer 생성 중...");const p=await this.createAudioBufferFromWasm(m,h,g);console.log("✓ AudioBuffer 생성 완료"),await this.audioPlayer.loadFromAudioBuffer(p),document.getElementById("play-pause-btn").disabled=!1,document.getElementById("stop-btn").disabled=!1,this.updateStatus(`로드 완료: ${a.name} (${h} Hz, ${g}채널)`)}catch(y){console.error("파일 로드 에러:",y),this.updateStatus(`에러: ${y.message}`)}}async createAudioBufferFromWasm(i,a,y){try{this.audioPlayer.audioContext||(this.audioPlayer.audioContext=new(window.AudioContext||window.webkitAudioContext));const f=this.wasmFunctions.getSamples();if(!f)throw new Error("WASM에서 샘플 데이터를 가져올 수 없습니다.");const c=this.audioPlayer.audioContext.createBuffer(y,i/y,a),d=f/4,A=this.wasmModule.HEAPF32;if(y===1){const m=c.getChannelData(0);for(let h=0;h<m.length;h++)m[h]=A[d+h]}else if(y===2){const m=c.getChannelData(0),h=c.getChannelData(1);for(let g=0;g<m.length;g++)m[g]=A[d+g*2],h[g]=A[d+g*2+1]}else throw new Error(`지원하지 않는 채널 수: ${y}`);return c}catch(f){throw console.error("AudioBuffer 생성 에러:",f),f}}togglePlayPause(){if(!this.audioPlayer)return;const i=document.getElementById("play-pause-btn");this.audioPlayer.isPlaying()?(this.audioPlayer.pause(),this.updateStatus("일시정지"),this.performanceMonitor.pause(),i.textContent="▶ 재생"):(this.audioPlayer.play(),this.updateStatus("재생 중..."),this.performanceMonitor.start(),i.textContent="⏸ 일시정지")}stop(){if(this.audioPlayer){this.audioPlayer.stop(),this.updateStatus("정지"),this.performanceMonitor.stop();const i=document.getElementById("play-pause-btn");i.textContent="▶ 재생"}}getWasmFrequencyData(){if(!this.wasmModule||!this.audioPlayer)return null;const i=this.audioPlayer.getCurrentTime(),a=this.wasmFunctions.getSampleRate(),y=Math.floor(i*a),f=this.audioPlayer.analyser?this.audioPlayer.analyser.fftSize:2048,c=f/2;this.currentFFTSize!==f&&(this.currentFFTSize=f,this.wasmFrequencyData=new Uint8Array(c),this.avgMagnitudesBuffer=new Float32Array(c));const d=this.wasmFunctions.getFFTDataAtOffset(y,f);if(!d)return this.audioPlayer.getFrequencyData();const A=d/4,m=this.wasmModule.HEAPF32;(!this.wasmFrequencyData||this.wasmFrequencyData.length!==c)&&(this.wasmFrequencyData=new Uint8Array(c));let h=0;for(let p=0;p<c;p++){const S=m[A+p];S>h&&(h=S)}const g=h>0?255/h:0;for(let p=0;p<c;p++){const S=m[A+p];this.wasmFrequencyData[p]=Math.min(255,Math.floor(S*g))}return this.wasmFrequencyData}updateStatus(i){document.getElementById("status").textContent=i}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new nt().init()}):new nt().init();
