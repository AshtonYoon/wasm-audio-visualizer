import{V as z,P as U}from"./performance-monitor-Dvt__9VL.js";class A{constructor(e){this.size=e,this.cosTable=new Float32Array(e*e),this.sinTable=new Float32Array(e*e),this.computeTrigTables()}computeTrigTables(){const e=this.size;for(let t=0;t<e;t++)for(let i=0;i<e;i++){const s=2*Math.PI*t*i/e;this.cosTable[t*e+i]=Math.cos(s),this.sinTable[t*e+i]=Math.sin(s)}}createComplexArray(){return new Float32Array(this.size*2)}realTransform(e,t){const i=this.size;for(let s=0;s<i;s++){let o=0,r=0;for(let n=0;n<i;n++){const a=this.cosTable[s*i+n],c=this.sinTable[s*i+n];o+=t[n]*a,r+=-t[n]*c}e[2*s]=o,e[2*s+1]=r}}inverseTransform(e,t){const i=this.size;for(let s=0;s<i;s++){let o=0,r=0;for(let n=0;n<i;n++){const a=this.cosTable[n*i+s],c=this.sinTable[n*i+s],u=t[2*n],l=t[2*n+1];o+=u*a-l*c,r+=u*c+l*a}e[2*s]=o/i,e[2*s+1]=r/i}}complexTransform(e,t){const i=this.size;for(let s=0;s<i;s++){let o=0,r=0;for(let n=0;n<i;n++){const a=this.cosTable[s*i+n],c=this.sinTable[s*i+n],u=t[2*n],l=t[2*n+1];o+=u*a+l*c,r+=l*a-u*c}e[2*s]=o,e[2*s+1]=r}}}class S{constructor(){this.audioData=null,this.sampleRate=44100,this.channels=2,this.duration=0,this.audioElement=null,this.isPlaying=!1,this.visualizer=null,this.performanceMonitor=null,this.fftSize=2048,this.fft=null,this.fftInput=null,this.fftOutput=null,this.frequencyData=null}async init(){try{console.log("초기화 시작..."),document.getElementById("loading").classList.add("active"),this.updateStatus("순수 JavaScript DFT 비주얼라이저 초기화 중..."),console.log("오디오 엘리먼트 생성 중..."),this.audioElement=new Audio,this.audioElement.addEventListener("play",()=>{this.isPlaying=!0}),this.audioElement.addEventListener("pause",()=>{this.isPlaying=!1}),this.audioElement.addEventListener("ended",()=>{this.isPlaying=!1}),console.log("오디오 엘리먼트 생성 완료:",this.audioElement),console.log("Visualizer3D 생성 중..."),this.visualizer=new z("canvas-container"),console.log("Visualizer3D 생성 완료:",this.visualizer),console.log("PerformanceMonitor 생성 중...");try{this.performanceMonitor=new U,this.performanceMonitor.start(),console.log("PerformanceMonitor 생성 및 시작 완료:",this.performanceMonitor)}catch(e){console.error("PerformanceMonitor 생성 실패:",e),this.performanceMonitor={beginFrame:()=>{},endFrame:()=>{},beginFFT:()=>{},endFFT:()=>{}}}console.log("DFT 초기화 중, 크기:",this.fftSize),this.initFFT(this.fftSize),console.log("DFT 초기화 완료:",this.fft),console.log("이벤트 리스너 설정 중..."),this.setupEventListeners(),document.getElementById("loading").classList.remove("active"),this.updateStatus("준비 완료. 오디오 파일을 로드하세요."),console.log("순수 JavaScript DFT 비주얼라이저 초기화 완료")}catch(e){console.error("앱 초기화 실패:",e),console.error("에러 스택:",e.stack),this.updateStatus("에러: 비주얼라이저 초기화 실패. 콘솔을 확인하세요.")}}initFFT(e){this.fftSize=e,this.fft=new A(e),this.fftInput=new Float32Array(e),this.fftOutput=this.fft.createComplexArray(),this.frequencyData=new Uint8Array(e/2),console.log(`순수 JavaScript DFT 초기화 완료, 크기: ${e}`)}setFFTSize(e){this.initFFT(e),console.log(`FFT 크기 변경: ${e}`)}setupEventListeners(){document.getElementById("audio-file").addEventListener("change",r=>this.handleFileSelect(r)),document.getElementById("play-pause-btn").addEventListener("click",()=>this.togglePlayPause()),document.getElementById("stop-btn").addEventListener("click",()=>this.stop()),document.getElementById("fft-size").addEventListener("change",r=>{const n=parseInt(r.target.value);this.setFFTSize(n)}),document.getElementById("color-scheme").addEventListener("change",r=>{const n=r.target.value;this.visualizer&&this.visualizer.setColorScheme(n)});const s=document.getElementById("sensitivity"),o=document.getElementById("sensitivity-value");s.addEventListener("input",r=>{const n=parseFloat(r.target.value);o.textContent=n.toFixed(1),this.visualizer&&this.visualizer.setSensitivity(n)}),this.animate()}async handleFileSelect(e){const t=e.target.files[0];if(t)try{this.updateStatus(`${t.name} 로딩 중...`),console.log(`파일 로드 중: ${t.name}, 타입: ${t.type}, 크기: ${t.size} bytes`);const i=performance.now(),s=await t.arrayBuffer();console.log(`ArrayBuffer 로드 완료, 크기: ${s.byteLength} bytes`),this.updateStatus(`${t.name} 파싱 중...`),console.log("WAV 파일 파싱 중...");try{const n=this.parseWAV(s);this.audioData=n.audioData,this.sampleRate=n.sampleRate,this.channels=n.channels,this.duration=n.duration}catch(n){throw console.error("WAV 파싱 에러:",n),new Error(`${t.name} 파싱 실패. WAV 포맷만 지원됩니다.`)}const o=performance.now()-i;console.log(`✓ 파싱 완료: ${t.name}, ${this.duration.toFixed(2)}초, ${this.sampleRate}Hz, ${this.channels}채널`),console.log(`로드 시간: ${o.toFixed(2)}ms`);const r=URL.createObjectURL(t);this.audioElement.src=r,this.audioElement.load(),document.getElementById("play-pause-btn").disabled=!1,document.getElementById("stop-btn").disabled=!1,this.updateStatus(`재생 준비 완료: ${t.name}`)}catch(i){console.error("오디오 파일 로드 실패:",i),this.updateStatus(`에러: ${i.message}`)}}parseWAV(e){const t=new DataView(e);if(String.fromCharCode(t.getUint8(0),t.getUint8(1),t.getUint8(2),t.getUint8(3))!=="RIFF")throw new Error("유효한 WAV 파일이 아닙니다 (RIFF 헤더 누락)");if(String.fromCharCode(t.getUint8(8),t.getUint8(9),t.getUint8(10),t.getUint8(11))!=="WAVE")throw new Error("유효한 WAV 파일이 아닙니다 (WAVE 포맷 누락)");let o=12;for(;o<t.byteLength;){const r=String.fromCharCode(t.getUint8(o),t.getUint8(o+1),t.getUint8(o+2),t.getUint8(o+3)),n=t.getUint32(o+4,!0);if(r==="fmt "){const a=t.getUint16(o+10,!0),c=t.getUint32(o+12,!0),u=t.getUint16(o+22,!0);console.log(`WAV 포맷: ${a}채널, ${c}Hz, ${u}bit`);let l=o+8+n;for(;l<t.byteLength;){const v=String.fromCharCode(t.getUint8(l),t.getUint8(l+1),t.getUint8(l+2),t.getUint8(l+3)),y=t.getUint32(l+4,!0);if(v==="data"){const d=y/(u/8)/a,F=new Float32Array(d);let T=0;const b=u/8,w=l+8;for(let g=0;g<d;g++){let E=0;for(let p=0;p<a;p++){const h=w+(g*a+p)*b;let f=0;if(u===16)f=t.getInt16(h,!0)/32768;else if(u===8)f=(t.getUint8(h)-128)/128;else if(u===24){const I=t.getUint8(h),D=t.getUint8(h+1);f=(t.getInt8(h+2)<<16|D<<8|I)/8388608}else u===32&&(f=t.getFloat32(h,!0));E+=f}F[T++]=E/a}return{audioData:F,sampleRate:c,channels:a,duration:d/c}}l+=8+y}throw new Error("WAV 파일에서 data 청크를 찾을 수 없습니다")}o+=8+n}throw new Error("WAV 파일에서 fmt 청크를 찾을 수 없습니다")}togglePlayPause(){if(!this.audioData||!this.audioElement)return;const e=document.getElementById("play-pause-btn");this.isPlaying?(this.audioElement.pause(),e.textContent="▶ 재생",console.log("재생 일시정지")):(this.audioElement.play(),e.textContent="⏸ 일시정지",console.log("재생 시작"))}stop(){if(!this.audioElement)return;this.audioElement.pause(),this.audioElement.currentTime=0;const e=document.getElementById("play-pause-btn");e.textContent="▶ 재생",console.log("재생 정지")}getCurrentTime(){return this.audioElement?this.audioElement.currentTime:0}animate(){if(requestAnimationFrame(()=>this.animate()),this.performanceMonitor.beginFrame(),this.isPlaying&&this.audioData){this.performanceMonitor.beginFFT();const e=this.getFrequencyData();this.performanceMonitor.endFFT(),e&&this.visualizer&&this.visualizer.updateFrequency(e)}this.visualizer&&this.visualizer.render(),this.performanceMonitor.endFrame()}getFrequencyData(){if(!this.audioData||!this.isPlaying)return null;const e=this.getCurrentTime(),t=Math.floor(e*this.sampleRate),i=this.audioData,s=this.fftSize;if(t+s>i.length)return null;for(let a=0;a<s;a++){const c=.5*(1-Math.cos(2*Math.PI*a/(s-1)));this.fftInput[a]=i[t+a]*c}this.fft.realTransform(this.fftOutput,this.fftInput);const o=this.fftSize/2;let r=0;for(let a=0;a<o;a++){const c=this.fftOutput[a*2],u=this.fftOutput[a*2+1],l=Math.sqrt(c*c+u*u);l>r&&(r=l),this.frequencyData[a]=l}const n=r>0?255/r:0;for(let a=0;a<o;a++)this.frequencyData[a]=Math.min(255,Math.floor(this.frequencyData[a]*n));return this.frequencyData}updateStatus(e){document.getElementById("status").textContent=e}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new S().init()}):new S().init();
